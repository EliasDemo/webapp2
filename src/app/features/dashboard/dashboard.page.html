<!-- dashboard.page.html -->

<!-- Loader -->
<div *ngIf="loading" class="text-center py-5">
  <div class="spinner-border" role="status">
    <span class="visually-hidden">Cargando...</span>
  </div>
</div>

<!-- Error -->
<div *ngIf="!loading && error" class="alert alert-danger mt-3">
  {{ error }}
</div>

<!-- Contenido principal -->
<div *ngIf="!loading && !error && data as d; else noData" class="dashboard">

  <!-- Header / contexto -->
  <section class="mb-4">
    <h2 class="mb-1">Panel de actividades</h2>

    <p class="text-muted mb-0">
      Periodo:
      <strong>{{ d.contexto.periodo.codigo }}</strong>

      <span *ngIf="d.contexto.periodo.vigente" class="badge bg-success ms-2">
        Vigente
      </span>
      <span *ngIf="!d.contexto.periodo.vigente" class="badge bg-secondary ms-2">
        No vigente
      </span>
    </p>

    <small class="text-muted">
      Actualizado: {{ d.contexto.ahora }}
    </small>
  </section>

  <!-- Contadores -->
  <section class="row g-3 mb-4">
    <div class="col-6 col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="small text-muted">Proyectos inscritos</div>
          <div class="fs-3 fw-semibold">
            {{ d.contadores.proyectos_inscritos }}
          </div>
        </div>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="small text-muted">Horas validadas</div>
          <div class="fs-3 fw-semibold">
            {{ d.contadores.horas_validadas_h | number: '1.0-2' }} h
          </div>
          <small class="text-muted">
            ({{ d.contadores.horas_validadas_min }} min)
          </small>
        </div>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="small text-muted">Faltas en eventos</div>
          <div class="fs-3 fw-semibold text-danger">
            {{ d.contadores.faltas_eventos }}
          </div>
        </div>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="small text-muted">Faltas en proyectos</div>
          <div class="fs-3 fw-semibold text-danger">
            {{ d.contadores.faltas_proyectos }}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Listas de eventos / proyectos -->
  <div class="row g-4">

    <!-- Eventos -->
    <div class="col-lg-6">

      <!-- Eventos inscritos -->
      <section>
        <h3 class="h5 mb-3">Eventos inscritos</h3>

        <div *ngIf="eventosInscritos.length; else noEventosInscritos">
          <div class="list-group small">
            <a
              *ngFor="let ev of eventosInscritos"
              class="list-group-item list-group-item-action flex-column align-items-start"
            >
              <div class="d-flex w-100 justify-content-between">
                <h4 class="h6 mb-1">{{ ev.titulo }}</h4>
                <span class="badge bg-light text-muted">{{ ev.codigo }}</span>
              </div>

              <p class="mb-1" *ngIf="ev.descripcion_corta">
                {{ ev.descripcion_corta }}
              </p>

              <small class="text-muted">
                {{ ev.sesiones?.[0]?.fecha }}
                · {{ ev.modalidad || 'Presencial' }}
                <span *ngIf="ev.progreso">
                  · Progreso: {{ ev.progreso.porcentaje }}%
                  ({{ ev.progreso.asistidas }}/{{ ev.progreso.totales }} sesiones)
                </span>
              </small>
            </a>
          </div>
        </div>

        <ng-template #noEventosInscritos>
          <p class="text-muted small mb-0">
            Aún no estás inscrito en ningún evento.
          </p>
        </ng-template>
      </section>

      <!-- Eventos inscribibles -->
      <section class="mt-4">
        <h3 class="h5 mb-3">Eventos disponibles para inscribirte</h3>

        <div *ngIf="eventosInscribibles.length; else noEventosDisponibles">
          <div class="list-group small">
            <div
              *ngFor="let ev of eventosInscribibles"
              class="list-group-item flex-column align-items-start"
            >
              <div class="d-flex w-100 justify-content-between">
                <h4 class="h6 mb-1">{{ ev.titulo }}</h4>
                <span class="badge bg-primary-subtle text-primary">
                  {{ ev.modalidad || 'Presencial' }}
                </span>
              </div>

              <p class="mb-1" *ngIf="ev.descripcion_corta">
                {{ ev.descripcion_corta }}
              </p>

              <small class="text-muted">
                Inscripción:
                <span *ngIf="ev.inscripcion_desde">
                  desde {{ ev.inscripcion_desde }}
                </span>
                <span *ngIf="ev.inscripcion_hasta">
                  · hasta {{ ev.inscripcion_hasta }}
                </span>
              </small>
            </div>
          </div>
        </div>

        <ng-template #noEventosDisponibles>
          <p class="text-muted small mb-0">
            No hay eventos disponibles para inscribirte en este periodo.
          </p>
        </ng-template>
      </section>
    </div>

    <!-- Proyectos -->
    <div class="col-lg-6">

      <!-- Proyectos inscritos -->
      <section>
        <h3 class="h5 mb-3">Proyectos inscritos</h3>

        <div *ngIf="proyectosInscritos.length; else noProyectosInscritos">
          <div class="list-group small">
            <a
              *ngFor="let p of proyectosInscritos"
              class="list-group-item list-group-item-action flex-column align-items-start"
            >
              <div class="d-flex w-100 justify-content-between">
                <h4 class="h6 mb-1">{{ p.titulo }}</h4>
                <span class="badge bg-light text-muted">{{ p.codigo }}</span>
              </div>

              <p class="mb-1" *ngIf="p.descripcion">
                {{ p.descripcion }}
              </p>

              <small class="text-muted">
                Tipo: {{ p.tipo }}
                · Modalidad: {{ p.modalidad || 'Presencial' }}
                · Progreso: {{ p.progreso?.porcentaje ?? 0 }}%
              </small>
            </a>
          </div>
        </div>

        <ng-template #noProyectosInscritos>
          <p class="text-muted small mb-0">
            Aún no estás inscrito en ningún proyecto.
          </p>
        </ng-template>
      </section>

      <!-- Proyectos inscribibles -->
      <section class="mt-4">
        <h3 class="h5 mb-3">Proyectos disponibles</h3>

        <div *ngIf="proyectosInscribibles.length; else noProyectosDisponibles">
          <div class="list-group small">
            <div
              *ngFor="let p of proyectosInscribibles"
              class="list-group-item flex-column align-items-start"
            >
              <div class="d-flex w-100 justify-content-between">
                <h4 class="h6 mb-1">{{ p.titulo }}</h4>
                <span class="badge bg-info-subtle text-info">
                  Nivel:
                  <ng-container *ngIf="p.ciclos?.length; else sinNivel">
                    {{ p.ciclos.join(', ') }}
                  </ng-container>
                  <ng-template #sinNivel>N/D</ng-template>
                </span>
              </div>

              <p class="mb-1" *ngIf="p.descripcion">
                {{ p.descripcion }}
              </p>

              <small class="text-muted">
                Tipo: {{ p.tipo }}
                · Modalidad: {{ p.modalidad || 'Presencial' }}
              </small>
            </div>
          </div>
        </div>

        <ng-template #noProyectosDisponibles>
          <p class="text-muted small mb-0">
            No hay proyectos disponibles para inscribirte en este periodo.
          </p>
        </ng-template>
      </section>
    </div>
  </div>
</div>

<!-- Fallback si no hay data -->
<ng-template #noData>
  <p class="text-muted">
    No se encontraron datos para el dashboard.
  </p>
</ng-template>
