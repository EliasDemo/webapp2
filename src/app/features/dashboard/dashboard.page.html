<!-- Loader global -->
<div *ngIf="loading" class="flex justify-center items-center py-12">
  <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
  <span class="ml-2 text-gray-600">Cargando...</span>
</div>

<!-- Error global -->
<div *ngIf="!loading && error" class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700">
  {{ error }}
</div>

<!-- Contenido principal -->
<div *ngIf="!loading && !error && data as d; else noData" class="dashboard p-4 md:p-6">

  <!-- Header / contexto -->
  <section class="mb-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-2">Panel de actividades</h2>

    <div class="flex flex-col sm:flex-row sm:items-center gap-2 text-gray-600">
      <p class="mb-0">
        Período:
        <strong class="font-semibold">{{ d.contexto.periodo.codigo }}</strong>

        <span *ngIf="d.contexto.periodo.vigente" class="ml-2 px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">
          Vigente
        </span>
        <span *ngIf="!d.contexto.periodo.vigente" class="ml-2 px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full">
          No vigente
        </span>
      </p>

      <span class="hidden sm:block text-gray-400">•</span>
      <small class="text-gray-500">
        Actualizado: {{ d.contexto.ahora }}
      </small>
    </div>
  </section>

  <!-- Contadores -->
  <section class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
      <div class="text-sm text-gray-500">Proyectos inscritos</div>
      <div class="text-3xl font-bold text-gray-800 mt-1">
        {{ d.contadores.proyectos_inscritos }}
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
      <div class="text-sm text-gray-500">Horas validadas</div>
      <div class="text-3xl font-bold text-gray-800 mt-1">
        {{ d.contadores.horas_validadas_h | number: '1.0-2' }} h
      </div>
      <div class="text-xs text-gray-500 mt-1">
        ({{ d.contadores.horas_validadas_min }} min)
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
      <div class="text-sm text-gray-500">Faltas en eventos</div>
      <div class="text-3xl font-bold text-red-600 mt-1">
        {{ d.contadores.faltas_eventos }}
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
      <div class="text-sm text-gray-500">Faltas en proyectos</div>
      <div class="text-3xl font-bold text-red-600 mt-1">
        {{ d.contadores.faltas_proyectos }}
      </div>
    </div>
  </section>

  <!-- ╔═══════════════════════ EVENTOS ═══════════════════════╗ -->
  <section class="mt-4">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
      <h3 class="text-xl font-semibold text-gray-800">Eventos</h3>

      <div class="inline-flex rounded-full bg-gray-100 p-1 text-xs sm:text-sm">
        <button
          type="button"
          class="px-3 py-1 rounded-full"
          [ngClass]="eventoTab === 'inscritos'
            ? 'bg-white shadow-sm text-gray-900'
            : 'text-gray-500 hover:text-gray-800'"
          (click)="eventoTab = 'inscritos'">
          Mis eventos
        </button>
        <button
          type="button"
          class="px-3 py-1 rounded-full"
          [ngClass]="eventoTab === 'inscribibles'
            ? 'bg-white shadow-sm text-gray-900'
            : 'text-gray-500 hover:text-gray-800'"
          (click)="eventoTab = 'inscribibles'">
          Para inscribirme
        </button>
      </div>
    </div>

    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
      <!-- Lista lateral de eventos (tipo portada) -->
      <div class="xl:col-span-1 space-y-3 max-h-[520px] overflow-y-auto pr-1">
        <ng-container *ngIf="eventosLista.length; else noEventosLista">
          <article
            *ngFor="let ev of eventosLista"
            (click)="verDetalleEvento(ev)"
            class="border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50 transition-colors"
            [ngClass]="{'border-blue-400 bg-blue-50/60': selectedEventoBase?.id === ev.id}">
            <div class="flex items-start gap-3">
              <div class="flex-1">
                <h4 class="text-sm font-semibold text-gray-800 line-clamp-2">
                  {{ ev.titulo }}
                </h4>
                <p class="mt-1 text-xs text-gray-500 line-clamp-2" *ngIf="ev.descripcion_corta">
                  {{ ev.descripcion_corta }}
                </p>
                <div class="mt-1 text-[11px] text-gray-500 flex flex-wrap gap-1">
                  <span *ngIf="ev.sesiones?.length">
                    {{ ev.sesiones[0].fecha }}
                  </span>
                  <span *ngIf="ev.modalidad">• {{ ev.modalidad }}</span>
                  <span *ngIf="ev.requiere_inscripcion">• Requiere inscripción</span>
                </div>
              </div>

              <div class="w-16 h-16 rounded-md overflow-hidden bg-gray-100 flex-shrink-0" *ngIf="ev.url_imagen_portada">
                <img [src]="ev.url_imagen_portada" class="w-full h-full object-cover" />
              </div>
            </div>
          </article>
        </ng-container>

        <ng-template #noEventosLista>
          <p class="text-sm text-gray-500">
            No hay eventos en esta categoría.
          </p>
        </ng-template>
      </div>

      <!-- Artículo principal del evento -->
      <div class="xl:col-span-2">
        <div *ngIf="loadingEventoFull" class="flex items-center text-gray-500 text-sm">
          <span class="animate-spin rounded-full h-4 w-4 border-b-2 border-gray-400 mr-2"></span>
          Cargando detalle del evento...
        </div>

        <ng-container *ngIf="!loadingEventoFull">
          <article *ngIf="selectedEventoFull as evFull; else placeholderEvento"
                   class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <!-- Imagen principal / carrusel -->
            <div *ngIf="evFull.imagenes?.length || evFull.url_imagen_portada" class="relative">
              <ng-container *ngIf="evFull.imagenes?.length; else portadaSimpleEvento">
                <img
                  class="w-full h-64 object-cover"
                  [src]="evFull.imagenes[eventoSlideIndex].url"
                  [alt]="evFull.imagenes[eventoSlideIndex].titulo || evFull.titulo"
                />
                <button
                  *ngIf="evFull.imagenes.length > 1"
                  class="absolute inset-y-0 left-0 px-2 flex items-center text-white text-sm bg-black/30 hover:bg-black/50"
                  (click)="prevEventoImage()">
                  ‹
                </button>
                <button
                  *ngIf="evFull.imagenes.length > 1"
                  class="absolute inset-y-0 right-0 px-2 flex items-center text-white text-sm bg-black/30 hover:bg-black/50"
                  (click)="nextEventoImage()">
                  ›
                </button>
                <div class="absolute bottom-2 right-2 text-[10px] px-2 py-0.5 rounded-full bg-black/60 text-white">
                  {{ eventoSlideIndex + 1 }} / {{ evFull.imagenes.length }}
                </div>
              </ng-container>

              <ng-template #portadaSimpleEvento>
                <img
                  class="w-full h-64 object-cover"
                  [src]="evFull.url_imagen_portada!"
                  [alt]="evFull.titulo"
                />
              </ng-template>
            </div>

            <div class="p-4 md:p-6">
              <div class="flex flex-wrap items-start justify-between gap-3">
                <div>
                  <h4 class="text-xl font-semibold text-gray-900">
                    {{ evFull.titulo }}
                  </h4>
                  <p *ngIf="evFull.subtitulo" class="text-sm text-gray-600 mt-1">
                    {{ evFull.subtitulo }}
                  </p>
                </div>
                <span class="px-2 py-1 text-xs rounded-full"
                      [ngClass]="{
                        'bg-green-50 text-green-700': evFull.estado === 'EN_CURSO',
                        'bg-yellow-50 text-yellow-700': evFull.estado === 'PLANIFICADO',
                        'bg-gray-100 text-gray-600': evFull.estado !== 'EN_CURSO' && evFull.estado !== 'PLANIFICADO'
                      }">
                  {{ evFull.estado }}
                </span>
              </div>

              <div class="mt-2 text-xs text-gray-500 flex flex-wrap gap-2">
                <span *ngIf="evFull.modalidad">Modalidad: <strong>{{ evFull.modalidad }}</strong></span>
                <span *ngIf="evFull.periodo?.codigo">• Período: <strong>{{ evFull.periodo?.codigo }}</strong></span>
                <span *ngIf="evFull.categoria?.nombre">• Categoría: <strong>{{ evFull.categoria?.nombre }}</strong></span>
              </div>

              <p class="mt-4 text-sm text-gray-800" *ngIf="evFull.descripcion_corta; else descLargaEvento">
                {{ evFull.descripcion_corta }}
              </p>
              <ng-template #descLargaEvento>
                <p *ngIf="evFull.descripcion_larga" class="mt-4 text-sm text-gray-800 whitespace-pre-line">
                  {{ evFull.descripcion_larga }}
                </p>
              </ng-template>

              <div class="mt-4 grid sm:grid-cols-2 gap-3 text-xs text-gray-600">
                <div>
                  <h5 class="font-semibold text-gray-800 mb-1">Sesiones</h5>
                  <div *ngIf="evFull.sesiones?.length; else sinSesiones">
                    <ul class="space-y-1">
                      <li *ngFor="let s of evFull.sesiones">
                        {{ s.fecha }} • {{ s.hora_inicio }} - {{ s.hora_fin }} ({{ s.estado }})
                      </li>
                    </ul>
                  </div>
                  <ng-template #sinSesiones>
                    <p class="text-gray-400">Sin sesiones registradas.</p>
                  </ng-template>
                </div>

                <div class="space-y-1">
                  <h5 class="font-semibold text-gray-800 mb-1">Inscripción</h5>
                  <p *ngIf="evFull.requiere_inscripcion; else noReqEv" class="text-xs text-gray-600">
                    Requiere inscripción previa.
                    <br />
                    <span *ngIf="evFull.inscripcion_desde">Desde: {{ evFull.inscripcion_desde }}</span>
                    <br *ngIf="evFull.inscripcion_hasta" />
                    <span *ngIf="evFull.inscripcion_hasta">Hasta: {{ evFull.inscripcion_hasta }}</span>
                    <br *ngIf="evFull.cupo_maximo" />
                    <span *ngIf="evFull.cupo_maximo">Cupo máximo: {{ evFull.cupo_maximo }}</span>
                  </p>
                  <ng-template #noReqEv>
                    <p class="text-xs text-gray-500">Este evento no requiere inscripción previa.</p>
                  </ng-template>

                  <p *ngIf="evFull.lugar_detallado" class="text-xs text-gray-600 mt-2">
                    <span class="font-semibold">Lugar:</span> {{ evFull.lugar_detallado }}
                  </p>

                  <p *ngIf="evFull.url_enlace_virtual" class="text-xs text-blue-600 mt-1">
                    Enlace virtual: {{ evFull.url_enlace_virtual }}
                  </p>

                  <button
                    *ngIf="puedeInscribirseEventoDetalle"
                    class="mt-3 inline-flex items-center px-3 py-1.5 rounded-md text-xs font-medium
                           bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50"
                    (click)="inscribirDesdeDetalleEvento()"
                    [disabled]="inscribiendoId?.tipo === 'evento' && inscribiendoId?.id === selectedEventoBase?.id">
                    Inscribirme en este evento
                  </button>
                </div>
              </div>
            </div>
          </article>

          <ng-template #placeholderEvento>
            <div class="h-full flex items-center justify-center text-sm text-gray-400 border border-dashed border-gray-300 rounded-xl p-6">
              Selecciona un evento de la lista para ver los detalles completos.
            </div>
          </ng-template>
        </ng-container>
      </div>
    </div>
  </section>

  <!-- ╔═══════════════════════ PROYECTOS ═════════════════════╗ -->
  <section class="mt-10">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
      <h3 class="text-xl font-semibold text-gray-800">Proyectos</h3>

      <div class="inline-flex rounded-full bg-gray-100 p-1 text-xs sm:text-sm">
        <button
          type="button"
          class="px-3 py-1 rounded-full"
          [ngClass]="proyectoTab === 'inscritos'
            ? 'bg-white shadow-sm text-gray-900'
            : 'text-gray-500 hover:text-gray-800'"
          (click)="proyectoTab = 'inscritos'">
          Mis proyectos
        </button>
        <button
          type="button"
          class="px-3 py-1 rounded-full"
          [ngClass]="proyectoTab === 'inscribibles'
            ? 'bg-white shadow-sm text-gray-900'
            : 'text-gray-500 hover:text-gray-800'"
          (click)="proyectoTab = 'inscribibles'">
          Para inscribirme
        </button>
      </div>
    </div>

    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
      <!-- Lista lateral de proyectos -->
      <div class="xl:col-span-1 space-y-3 max-h-[520px] overflow-y-auto pr-1">
        <ng-container *ngIf="proyectosLista.length; else noProyectosLista">
          <article
            *ngFor="let p of proyectosLista"
            (click)="verDetalleProyecto(p)"
            class="border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50 transition-colors"
            [ngClass]="{'border-indigo-400 bg-indigo-50/60': selectedProyectoBase?.id === p.id}">
            <div class="flex items-start gap-3">
              <div class="flex-1">
                <h4 class="text-sm font-semibold text-gray-800 line-clamp-2">
                  {{ p.titulo }}
                </h4>
                <p class="mt-1 text-xs text-gray-500 line-clamp-2" *ngIf="p.descripcion">
                  {{ p.descripcion }}
                </p>
                <div class="mt-1 text-[11px] text-gray-500 flex flex-wrap gap-1">
                  <span>Tipo: {{ p.tipo }}</span>
                  <span>• {{ p.modalidad || 'Presencial' }}</span>
                </div>
              </div>

              <div class="w-16 h-16 rounded-md overflow-hidden bg-gray-100 flex-shrink-0" *ngIf="p.imagenes?.length">
                <img [src]="p.imagenes[0].url" class="w-full h-full object-cover" />
              </div>
            </div>
          </article>
        </ng-container>

        <ng-template #noProyectosLista>
          <p class="text-sm text-gray-500">
            No hay proyectos en esta categoría.
          </p>
        </ng-template>
      </div>

      <!-- Artículo principal del proyecto -->
      <div class="xl:col-span-2">
        <div *ngIf="loadingProyectoFull" class="flex items-center text-gray-500 text-sm">
          <span class="animate-spin rounded-full h-4 w-4 border-b-2 border-gray-400 mr-2"></span>
          Cargando detalle del proyecto...
        </div>

        <ng-container *ngIf="!loadingProyectoFull">
          <article *ngIf="selectedProyectoFull as pFull; else placeholderProyecto"
                   class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <!-- Imagen / carrusel -->
            <div *ngIf="pFull.imagenes?.length" class="relative">
              <img
                class="w-full h-64 object-cover"
                [src]="pFull.imagenes[proyectoSlideIndex].url"
                [alt]="pFull.imagenes[proyectoSlideIndex].titulo || pFull.titulo"
              />
              <button
                *ngIf="pFull.imagenes.length > 1"
                class="absolute inset-y-0 left-0 px-2 flex items-center text-white text-sm bg-black/30 hover:bg-black/50"
                (click)="prevProyectoImage()">
                ‹
              </button>
              <button
                *ngIf="pFull.imagenes.length > 1"
                class="absolute inset-y-0 right-0 px-2 flex items-center text-white text-sm bg-black/30 hover:bg-black/50"
                (click)="nextProyectoImage()">
                ›
              </button>
              <div class="absolute bottom-2 right-2 text-[10px] px-2 py-0.5 rounded-full bg-black/60 text-white">
                {{ proyectoSlideIndex + 1 }} / {{ pFull.imagenes.length }}
              </div>
            </div>

            <div class="p-4 md:p-6">
              <div class="flex flex-wrap items-start justify-between gap-3">
                <div>
                  <h4 class="text-xl font-semibold text-gray-900">
                    {{ pFull.titulo }}
                  </h4>
                  <p class="text-xs text-gray-500 mt-1">
                    Código: {{ pFull.codigo }} • Tipo: {{ pFull.tipo }} • {{ pFull.modalidad || 'Presencial' }}
                  </p>
                </div>
                <span class="px-2 py-1 text-xs rounded-full"
                      [ngClass]="{
                        'bg-green-50 text-green-700': pFull.estado === 'EN_CURSO',
                        'bg-yellow-50 text-yellow-700': pFull.estado === 'PLANIFICADO',
                        'bg-gray-100 text-gray-600': pFull.estado !== 'EN_CURSO' && pFull.estado !== 'PLANIFICADO'
                      }">
                  {{ pFull.estado }}
                </span>
              </div>

              <p class="mt-4 text-sm text-gray-800" *ngIf="pFull.descripcion">
                {{ pFull.descripcion }}
              </p>

              <div class="mt-4 grid sm:grid-cols-2 gap-3 text-xs text-gray-600">
                <div>
                  <h5 class="font-semibold text-gray-800 mb-1">Carga horaria & niveles</h5>
                  <p>
                    Horas planificadas: <strong>{{ pFull.horas_planificadas }}</strong>
                    <span *ngIf="pFull.horas_minimas_participante">
                      (mínimo por alumno: {{ pFull.horas_minimas_participante }})
                    </span>
                  </p>
                  <p class="mt-1">
                    Niveles: <strong>{{ getProyectoNiveles(pFull) }}</strong>
                  </p>
                </div>

                <div>
                  <h5 class="font-semibold text-gray-800 mb-1">Procesos y sesiones</h5>
                  <p>
                    Procesos: <strong>{{ pFull.procesos.length }}</strong>
                    <span *ngIf="pFull.procesos.length">
                      • Sesiones: <strong>{{ getProyectoTotalSesiones(pFull) }}</strong>
                    </span>
                  </p>
                  <ul *ngIf="pFull.procesos?.length" class="mt-1 space-y-0.5 max-h-32 overflow-y-auto pr-1">
                    <li *ngFor="let pr of pFull.procesos">
                      <span class="font-semibold">{{ pr.nombre }}</span>
                      <span class="text-gray-500">
                        – {{ pr.sesiones?.length || 0 }} sesiones
                      </span>
                    </li>
                  </ul>

                  <button
                    *ngIf="puedeInscribirseProyectoDetalle"
                    class="mt-3 inline-flex items-center px-3 py-1.5 rounded-md text-xs font-medium
                           bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-50"
                    (click)="inscribirDesdeDetalleProyecto()"
                    [disabled]="inscribiendoId?.tipo === 'proyecto' && inscribiendoId?.id === selectedProyectoBase?.id">
                    Inscribirme en este proyecto
                  </button>
                </div>
              </div>
            </div>
          </article>

          <ng-template #placeholderProyecto>
            <div class="h-full flex items-center justify-center text-sm text-gray-400 border border-dashed border-gray-300 rounded-xl p-6">
              Selecciona un proyecto de la lista para ver los detalles completos.
            </div>
          </ng-template>
        </ng-container>
      </div>
    </div>
  </section>
</div>

<!-- Fallback si no hay data -->
<ng-template #noData>
  <div class="p-8 text-center">
    <p class="text-gray-500">
      No se encontraron datos para el dashboard.
    </p>
  </div>
</ng-template>
