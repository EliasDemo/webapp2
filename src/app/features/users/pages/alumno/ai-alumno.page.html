<!-- src/app/features/alumnoinspector/pages/alumno/ai-alumno.page.html -->
<div class="min-h-screen bg-gradient-to-br from-slate-50 to-violet-50/40 pb-16">

  <!-- Header -->
  <header class="border-b border-slate-200 bg-white/80 backdrop-blur-sm sticky top-0 z-10">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between gap-4">
        <div class="flex items-center gap-3">
          <div class="p-2 rounded-xl bg-violet-100 text-violet-700">
            <i class="fa-solid fa-user-magnifying-glass text-lg"></i>
          </div>
          <div>
            <nav class="text-xs text-slate-500 mb-1 flex items-center gap-1">
              <a routerLink="/" class="hover:text-slate-700 font-medium transition-colors">Inicio</a>
              <i class="fa-solid fa-chevron-right text-[10px] text-slate-400"></i>
              <a routerLink="/ai/resumen" class="hover:text-slate-700 font-medium transition-colors">
                Inspector
              </a>
              <i class="fa-solid fa-chevron-right text-[10px] text-slate-400"></i>
              <span class="text-violet-600 font-semibold">Alumno</span>
            </nav>
            <h1 class="text-2xl font-bold text-slate-900">Inspector de Alumno</h1>
            <p class="text-sm text-slate-600 mt-1">
              Consulta matrÃ­culas, horas VCM, proyectos y eventos; edita participaciones y asistencias de forma centralizada.
            </p>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 pt-8 space-y-8">

    <!-- Alertas globales -->
    <div *ngIf="error()"
         class="rounded-2xl border border-rose-200 bg-white p-4 shadow-sm">
      <div class="flex items-start gap-4">
        <div class="flex-shrink-0 p-2 rounded-lg bg-rose-100 text-rose-600">
          <i class="fa-solid fa-circle-exclamation text-sm"></i>
        </div>
        <div class="flex-1 min-w-0">
          <div class="font-semibold text-rose-900 mb-1">No se pudo completar la operaciÃ³n</div>
          <div class="text-sm text-rose-700">{{ error() }}</div>

          <div *ngIf="choices()?.length" class="mt-3 rounded-xl border border-amber-200 bg-amber-50/60 p-3">
            <div class="text-sm font-semibold text-amber-800 mb-2 flex items-center gap-2">
              <i class="fa-solid fa-lightbulb text-amber-600"></i>
              EP-SEDE disponibles para tu usuario
            </div>
            <div class="flex flex-wrap gap-2">
              <button
                *ngFor="let c of choices()"
                type="button"
                class="inline-flex items-center gap-2 rounded-lg border border-amber-300 bg-white px-3 py-1.5 text-xs font-medium text-amber-800 shadow-sm hover:bg-amber-50 transition-colors"
                (click)="usarEpSede(c)">
                <i class="fa-solid fa-building-columns text-amber-600 text-xs"></i>
                EP-SEDE {{ c }}
              </button>
            </div>
            <p class="text-xs text-amber-700 mt-2">
              Selecciona una EP-SEDE y vuelve a buscar al alumno.
            </p>
          </div>
        </div>
        <button
          (click)="error.set(null)"
          class="flex-shrink-0 text-slate-400 hover:text-slate-600 transition-colors">
          <i class="fa-solid fa-xmark text-sm"></i>
        </button>
      </div>
    </div>

    <!-- BÃºsqueda -->
    <section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
      <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
        <div class="flex items-center gap-3">
          <div class="p-2 rounded-xl bg-violet-100 text-violet-600">
            <i class="fa-solid fa-magnifying-glass"></i>
          </div>
          <div>
            <h2 class="text-lg font-bold text-slate-900">Buscar alumno</h2>
            <p class="text-xs text-slate-600">Usa cÃ³digo de estudiante o ID de expediente</p>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- EP-SEDE -->
        <div class="space-y-1">
          <label class="block text-xs font-semibold text-slate-700 uppercase tracking-wide">
            EP-SEDE (opcional)
          </label>
          <input
            type="number"
            class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2.5 text-sm transition-colors focus:border-violet-500 focus:ring-2 focus:ring-violet-200"
            [ngModel]="epSedeId() ?? ''"
            (ngModelChange)="epSedeId.set($event ? +$event : null)"
            placeholder="EP-SEDE del alumno" />
          <p class="text-[11px] text-slate-500">
            Si lo dejas vacÃ­o, el backend intentarÃ¡ resolverlo segÃºn tus permisos.
          </p>
        </div>

        <!-- CÃ³digo -->
        <div class="space-y-1">
          <label class="block text-xs font-semibold text-slate-700 uppercase tracking-wide">
            CÃ³digo de estudiante
          </label>
          <input
            type="text"
            class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2.5 text-sm transition-colors focus:border-violet-500 focus:ring-2 focus:ring-violet-200"
            [ngModel]="searchCodigo()"
            (ngModelChange)="searchCodigo.set($event)"
            placeholder="Ej: 00012345" />
        </div>

        <!-- Expediente ID -->
        <div class="space-y-1">
          <label class="block text-xs font-semibold text-slate-700 uppercase tracking-wide">
            ID de expediente
          </label>
          <input
            type="number"
            class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2.5 text-sm transition-colors focus:border-violet-500 focus:ring-2 focus:ring-violet-200"
            [ngModel]="searchExpedienteId() ?? ''"
            (ngModelChange)="searchExpedienteId.set($event ? +$event : null)"
            placeholder="Alternativa al cÃ³digo" />
        </div>

        <!-- BotÃ³n -->
        <div class="flex items-end">
          <button
            (click)="buscarAlumno()"
            [disabled]="loading() || (!searchCodigo() && !searchExpedienteId())"
            class="inline-flex items-center gap-2 rounded-xl bg-violet-600 px-5 py-2.5 text-sm font-semibold text-white hover:bg-violet-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 shadow-md hover:shadow-lg w-full md:w-auto">
            <i class="fa-solid fa-magnifying-glass" [class.hidden]="loading()"></i>
            <i *ngIf="loading()" class="fa-solid fa-circle-notch animate-spin"></i>
            {{ loading() ? 'Buscando...' : 'Buscar' }}
          </button>
        </div>
      </div>
    </section>

    <!-- Contenido principal del alumno -->
    <section *ngIf="alumnoData() as a" class="space-y-6">

      <!-- Cabecera con info del alumno + chips -->
      <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
        <div class="flex flex-wrap items-center justify-between gap-4">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-2xl bg-violet-100 text-violet-700 grid place-items-center">
              <i class="fa-solid fa-user text-xl"></i>
            </div>
            <div>
              <div class="text-sm font-semibold text-slate-900">
                {{ a.usuario.full_name || 'Alumno sin nombre registrado' }}
              </div>
              <div class="text-xs text-slate-500 mt-1">
                <span class="font-mono text-slate-800">
                  CÃ³digo: {{ a.expediente.codigo_estudiante || 'â€”' }}
                </span>
                Â·
                <span>ID expediente: {{ a.expediente.id }}</span>
              </div>
              <div class="mt-1 text-xs text-slate-500 space-x-2">
                <span *ngIf="a.usuario.email">ðŸ“§ {{ a.usuario.email }}</span>
                <span *ngIf="a.usuario.celular">ðŸ“± {{ a.usuario.celular }}</span>
                <span *ngIf="a.expediente.correo_institucional">
                  ðŸŽ“ {{ a.expediente.correo_institucional }}
                </span>
              </div>
            </div>
          </div>

          <div class="flex flex-wrap gap-2 text-xs justify-end">
            <span class="inline-flex items-center gap-1.5 rounded-full bg-slate-100 px-3 py-1 border border-slate-200 text-slate-700">
              <i class="fa-solid fa-building-columns text-[10px]"></i>
              EP-SEDE {{ a.expediente.ep_sede_id }}
            </span>
            <span
              class="inline-flex items-center gap-1.5 rounded-full px-3 py-1 border text-xs font-semibold"
              [ngClass]="(a.expediente.estado || '').toUpperCase()==='ACTIVO'
                         ? 'bg-emerald-50 border-emerald-200 text-emerald-700'
                         : 'bg-slate-50 border-slate-200 text-slate-600'">
              <i class="fa-solid fa-circle text-[6px]"></i>
              {{ a.expediente.estado || 'SIN ESTADO' }}
            </span>
            <span class="inline-flex items-center gap-1.5 rounded-full bg-indigo-50 px-3 py-1 border border-indigo-200 text-indigo-700">
              <i class="fa-solid fa-layer-group text-[10px]"></i>
              Ciclo {{ a.expediente.ciclo || 'â€”' }} Â· Grupo {{ a.expediente.grupo || 'â€”' }}
            </span>
          </div>
        </div>
      </div>

      <!-- Dos columnas principales: izquierda â€œacadÃ©mico/proyectosâ€, derecha â€œVCM/eventosâ€ -->
      <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">

        <!-- Columna izquierda: MatrÃ­culas + CatÃ¡logo de proyectos -->
        <div class="xl:col-span-1 space-y-6">

          <!-- MatrÃ­culas -->
          <div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
            <div class="flex items-center gap-3 mb-4">
              <div class="p-2 rounded-xl bg-slate-100 text-slate-600">
                <i class="fa-solid fa-graduation-cap text-sm"></i>
              </div>
              <div>
                <h3 class="text-sm font-semibold text-slate-900">MatrÃ­culas</h3>
                <p class="text-xs text-slate-500">Historial por perÃ­odo</p>
              </div>
            </div>

            <div *ngIf="!matriculas().length" class="text-xs text-slate-500">
              No se encontraron matrÃ­culas para este alumno.
            </div>

            <div *ngIf="matriculas().length" class="max-h-64 overflow-auto">
              <table class="w-full text-xs">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="px-2 py-2 text-left font-semibold text-slate-700">PerÃ­odo</th>
                    <th class="px-2 py-2 text-left font-semibold text-slate-700">Ciclo/Grupo</th>
                    <th class="px-2 py-2 text-left font-semibold text-slate-700">Fecha</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                  <tr *ngFor="let m of matriculas(); trackBy: trackMatricula" class="hover:bg-slate-50/50">
                    <td class="px-2 py-2">
                      <div class="font-mono text-slate-800">{{ m.periodo_codigo }}</div>
                      <div class="text-[11px] text-slate-500">
                        {{ m.periodo_estado || 'â€”' }}
                      </div>
                    </td>
                    <td class="px-2 py-2">
                      <div class="text-slate-800">
                        C {{ m.ciclo_matricula || 'â€”' }} / G {{ m.grupo || 'â€”' }}
                      </div>
                      <div class="text-[11px] text-slate-500">
                        {{ m.modalidad || 'â€”' }}
                      </div>
                    </td>
                    <td class="px-2 py-2">
                      <div class="text-slate-800">
                        {{ m.fecha_matricula || 'â€”' }}
                      </div>
                      <div class="text-[11px] text-slate-500">
                        {{ m.modo_contrato || 'â€”' }}
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- CatÃ¡logo de proyectos del alumno -->
          <div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm space-y-4">
            <div class="flex items-center gap-3">
              <div class="p-2 rounded-xl bg-slate-100 text-slate-600">
                <i class="fa-solid fa-diagram-project text-sm"></i>
              </div>
              <div>
                <h3 class="text-sm font-semibold text-slate-900">Proyectos VCM del alumno</h3>
                <p class="text-xs text-slate-500">
                  Selecciona un proyecto para ver sus sesiones y marcar asistencia
                </p>
              </div>
            </div>

            <div *ngIf="!proyectosAlumno().length" class="text-xs text-slate-500">
              Este alumno aÃºn no tiene horas VCM asociadas a proyectos.
            </div>

            <div *ngIf="proyectosAlumno().length" class="space-y-2 max-h-64 overflow-auto">
              <div
                *ngFor="let p of proyectosAlumno()"
                (click)="seleccionarProyecto(p)"
                class="rounded-xl border px-3 py-2 text-xs cursor-pointer transition-all"
                [ngClass]="selectedProyecto()?.proyecto_id === p.proyecto_id
                           ? 'border-blue-500 bg-blue-50/70 shadow-sm'
                           : 'border-slate-200 bg-slate-50/70 hover:border-blue-300 hover:bg-blue-50/40'">
                <div class="flex items-center justify-between gap-2">
                  <div>
                    <div class="font-mono text-slate-900">
                      {{ p.proyecto_codigo || 'â€”' }}
                    </div>
                    <div class="text-[11px] text-slate-600 truncate max-w-[180px]">
                      {{ p.proyecto_titulo || 'Sin tÃ­tulo' }}
                    </div>
                    <div class="text-[10px] text-slate-500">
                      {{ p.periodo_codigo }} Â· {{ p.tipo || 'â€”' }}
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="text-[11px] font-semibold text-emerald-700">
                      {{ p.total_horas | number:'1.1-1' }} h
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>

        <!-- Columna central: Sesiones del proyecto seleccionado -->
        <div class="xl:col-span-1 rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
          <div class="flex items-center gap-3 mb-4">
            <div class="p-2 rounded-xl bg-blue-100 text-blue-600">
              <i class="fa-solid fa-calendar-check text-sm"></i>
            </div>
            <div>
              <h3 class="text-sm font-semibold text-slate-900">Sesiones del proyecto</h3>
              <p class="text-xs text-slate-500">
                Vista detallada de sesiones y asistencia del alumno en el proyecto seleccionado
              </p>
            </div>
          </div>

          <div *ngIf="!selectedProyecto()">
            <p class="text-xs text-slate-500">
              Selecciona un proyecto en la columna izquierda para ver sus sesiones.
            </p>
          </div>

          <div *ngIf="selectedProyecto() as sel" class="space-y-3">
            <div class="flex items-center justify-between mb-2">
              <div class="text-xs">
                <div class="font-semibold text-slate-900">
                  {{ sel.proyecto_codigo || 'â€”' }} Â· {{ sel.proyecto_titulo || 'Sin tÃ­tulo' }}
                </div>
                <div class="text-[11px] text-slate-500">
                  PerÃ­odo {{ sel.periodo_codigo }} Â· {{ sel.tipo || 'â€”' }}
                </div>
              </div>
            </div>

            <div *ngIf="!sesionesProyecto().length" class="text-xs text-slate-500">
              No se encontraron sesiones para este proyecto o aÃºn no se han configurado.
            </div>

            <div *ngIf="sesionesProyecto().length" class="max-h-64 overflow-auto">
              <table class="w-full text-[11px]">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="px-2 py-2 text-left font-semibold text-slate-700">Fecha</th>
                    <th class="px-2 py-2 text-left font-semibold text-slate-700">Horario</th>
                    <th class="px-2 py-2 text-left font-semibold text-slate-700">Asistencia</th>
                    <th class="px-2 py-2 text-right font-semibold text-slate-700">AcciÃ³n</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                  <tr *ngFor="let s of sesionesProyecto(); trackBy: trackSesion"
                      class="hover:bg-slate-50/70">
                    <td class="px-2 py-2">
                      <div class="font-mono text-slate-900">
                        {{ s.fecha }}
                      </div>
                      <div class="text-[10px] text-slate-500">
                        {{ s.estado_sesion || 'â€”' }}
                      </div>
                    </td>
                    <td class="px-2 py-2">
                      <div class="text-slate-900">
                        {{ s.hora_inicio }} - {{ s.hora_fin }}
                      </div>
                    </td>
                    <td class="px-2 py-2">
                      <div *ngIf="s.asistencia; else sinAsis">
                        <div class="text-emerald-700 font-semibold">
                          {{ s.asistencia!.estado || 'VALIDADO' }}
                        </div>
                        <div class="text-[10px] text-slate-500">
                          {{ s.asistencia!.minutos_validados || 0 }} min
                        </div>
                      </div>
                      <ng-template #sinAsis>
                        <span class="text-[11px] text-slate-500">
                          Sin asistencia
                        </span>
                      </ng-template>
                    </td>
                    <td class="px-2 py-2 text-right">
                      <button
                        type="button"
                        (click)="marcarAsistenciaSesion(s)"
                        [disabled]="loading()"
                        class="inline-flex items-center gap-1 rounded-full bg-emerald-600 px-2.5 py-1 text-[10px] font-semibold text-white hover:bg-emerald-700 disabled:opacity-50">
                        <i class="fa-solid fa-check"></i>
                        Marcar asistencia
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

          </div>
        </div>

        <!-- Columna derecha: VCM resumen + eventos -->
        <div class="xl:col-span-1 space-y-6">

          <!-- Resumen VCM por perÃ­odo -->
          <div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
            <div class="flex items-center gap-3 mb-4">
              <div class="p-2 rounded-xl bg-emerald-100 text-emerald-600">
                <i class="fa-solid fa-chart-simple text-sm"></i>
              </div>
              <div>
                <h3 class="text-sm font-semibold text-slate-900">Resumen de horas VCM</h3>
                <p class="text-xs text-slate-500">Horas por perÃ­odo donde el alumno tiene registros</p>
              </div>
            </div>

            <div *ngIf="!vcmPeriodos().length" class="text-xs text-slate-500">
              No se encontraron registros de horas VCM.
            </div>

            <div *ngIf="vcmPeriodos().length" class="max-h-64 overflow-auto space-y-3">
              <div *ngFor="let p of vcmPeriodos(); trackBy: trackVcm"
                   class="rounded-xl border border-slate-100 bg-slate-50/70 p-3">
                <div class="flex items-center justify-between text-xs">
                  <div>
                    <div class="font-mono text-slate-900">{{ p.periodo_codigo }}</div>
                    <div class="text-[11px] text-slate-500">
                      {{ p.periodo_estado || 'â€”' }}
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="text-sm font-semibold text-emerald-700">
                      {{ p.total_horas | number:'1.1-1' }} h
                    </div>
                    <div class="text-[11px] text-slate-500">
                      {{ p.proyectos.length }} proyecto(s)
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Eventos -->
          <div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
            <div class="flex items-center gap-3 mb-4">
              <div class="p-2 rounded-xl bg-indigo-100 text-indigo-600">
                <i class="fa-solid fa-calendar-star text-sm"></i>
              </div>
            <div>
              <h3 class="text-sm font-semibold text-slate-900">Eventos del alumno</h3>
              <p class="text-xs text-slate-500">
                Eventos en los que participa el alumno y su estado actual
              </p>
            </div>
            </div>

            <div *ngIf="!eventos().length" class="text-xs text-slate-500">
              Este alumno aÃºn no tiene participaciÃ³n en eventos.
            </div>

            <div *ngIf="eventos().length" class="max-h-64 overflow-auto space-y-3">
              <div
                *ngFor="let e of eventos(); trackBy: trackEvento"
                class="rounded-xl border border-slate-100 bg-slate-50/70 p-3">
                <div class="flex items-center justify-between">
                  <div class="text-xs">
                    <div class="font-semibold text-slate-900">
                      {{ e.titulo || 'Evento sin tÃ­tulo' }}
                    </div>
                    <div class="text-[11px] text-slate-500">
                      {{ e.periodo.codigo }} Â· {{ e.modalidad || 'â€”' }}
                    </div>
                    <div class="text-[11px] text-slate-500 truncate max-w-[160px]">
                      {{ e.descripcion_corta || '' }}
                    </div>
                  </div>
                  <div class="flex flex-col items-end gap-2">
                    <span
                      class="inline-flex items-center gap-1.5 rounded-full px-2.5 py-1 text-[11px] font-semibold"
                      [ngClass]="eventoEstadoBadge(e)">
                      <i class="fa-solid fa-circle text-[6px]"></i>
                      {{ e.participacion.estado || 'SIN ESTADO' }}
                    </span>
                    <select
                      class="rounded-lg border border-slate-300 bg-white px-2 py-1 text-[11px] focus:border-violet-500 focus:ring-1 focus:ring-violet-200"
                      [ngModel]="e.participacion.estado"
                      (ngModelChange)="actualizarEstadoEvento(e, $event)">
                      <option [ngValue]="e.participacion.estado">â€” Cambiar estado â€”</option>
                      <option value="INSCRITO">INSCRITO</option>
                      <option value="CONFIRMADO">CONFIRMADO</option>
                      <option value="FINALIZADO">FINALIZADO</option>
                      <option value="CANCELADO">CANCELADO</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>

      </div>

      <!-- Acciones manuales extra (opcional) -->
      <section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm space-y-6">
        <div class="flex items-center gap-3 mb-2">
          <div class="p-2 rounded-xl bg-slate-100 text-slate-600">
            <i class="fa-solid fa-wrench text-sm"></i>
          </div>
          <div>
            <h3 class="text-sm font-semibold text-slate-900">Acciones manuales adicionales</h3>
            <p class="text-xs text-slate-500">
              InscripciÃ³n por perÃ­odo y registro manual de eventos
            </p>
          </div>
        </div>

        <div *ngIf="accionesError()" class="rounded-xl border border-amber-200 bg-amber-50/80 p-3 text-xs text-amber-800">
          <i class="fa-solid fa-circle-exclamation mr-1"></i>
          {{ accionesError() }}
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <!-- Inscribir en proyecto por perÃ­odo -->
          <div class="rounded-xl border border-slate-100 bg-slate-50/60 p-4 space-y-3">
            <div class="flex items-center gap-2">
              <div class="p-1.5 rounded-lg bg-blue-100 text-blue-600">
                <i class="fa-solid fa-folder-plus text-[11px]"></i>
              </div>
              <div>
                <div class="text-xs font-semibold text-slate-900">
                  Inscribir en proyecto (por perÃ­odo)
                </div>
                <div class="text-[11px] text-slate-500">
                  Usa el perÃ­odo de una matrÃ­cula y el catÃ¡logo de proyectos del sistema
                </div>
              </div>
            </div>

            <div class="space-y-2">
              <label class="block text-[11px] font-semibold text-slate-700">
                PerÃ­odo
              </label>
              <select
                class="w-full rounded-lg border border-slate-300 bg-white px-2.5 py-1.5 text-[13px]"
                [ngModel]="selectedMatriculaPeriodoId() ?? ''"
                (ngModelChange)="selectedMatriculaPeriodoId.set($event ? +$event : null)">
                <option [ngValue]="null">â€” Selecciona â€”</option>
                <option *ngFor="let m of matriculas()" [ngValue]="m.periodo_id">
                  {{ m.periodo_codigo }} Â· Ciclo {{ m.ciclo_matricula || m.ciclo_periodo }}
                </option>
              </select>
            </div>

            <button
              type="button"
              (click)="cargarProyectosPeriodoDesdeMatricula()"
              [disabled]="loading() || !matriculas().length"
              class="inline-flex items-center gap-2 rounded-lg bg-blue-600 px-3 py-1.5 text-[12px] font-semibold text-white hover:bg-blue-700 disabled:opacity-50">
              <i class="fa-solid fa-magnifying-glass"></i>
              Ver proyectos del perÃ­odo
            </button>

            <div *ngIf="proyectosPeriodo() as pp" class="mt-2 space-y-2 max-h-40 overflow-auto text-[11px]">
              <div class="text-slate-500">
                PerÃ­odo {{ pp.periodo.codigo }} Â· Nivel {{ pp.nivel ?? 'â€”' }}
              </div>

              <div *ngIf="pp.vinculados.length">
                <div class="font-semibold text-slate-800 mb-1">Vinculados</div>
                <div class="space-y-1">
                  <div *ngFor="let p of pp.vinculados"
                       class="flex items-center justify-between gap-2 bg-white rounded-lg border border-slate-200 px-2 py-1">
                    <div>
                      <div class="font-mono text-slate-900">{{ p.codigo || 'â€”' }}</div>
                      <div class="text-[11px] text-slate-500 truncate max-w-[140px]">
                        {{ p.titulo || 'Sin tÃ­tulo' }}
                      </div>
                    </div>
                    <button
                      type="button"
                      (click)="inscribirEnProyectoDesdeLista(p)"
                      [disabled]="loading()"
                      class="inline-flex items-center gap-1 rounded-full bg-emerald-600 px-2 py-1 text-[10px] font-semibold text-white hover:bg-emerald-700">
                      <i class="fa-solid fa-user-plus"></i>
                      Inscribir
                    </button>
                  </div>
                </div>
              </div>

              <div *ngIf="pp.libres.length" class="mt-2">
                <div class="font-semibold text-slate-800 mb-1">Libres</div>
                <div class="space-y-1">
                  <div *ngFor="let p of pp.libres"
                       class="flex items-center justify-between gap-2 bg-white rounded-lg border border-slate-200 px-2 py-1">
                    <div>
                      <div class="font-mono text-slate-900">{{ p.codigo || 'â€”' }}</div>
                      <div class="text-[11px] text-slate-500 truncate max-w-[140px]">
                        {{ p.titulo || 'Sin tÃ­tulo' }}
                      </div>
                    </div>
                    <button
                      type="button"
                      (click)="inscribirEnProyectoDesdeLista(p)"
                      [disabled]="loading()"
                      class="inline-flex items-center gap-1 rounded-full bg-sky-600 px-2 py-1 text-[10px] font-semibold text-white hover:bg-sky-700">
                      <i class="fa-solid fa-user-plus"></i>
                      Inscribir
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Marcar asistencias (entrada manual de IDs, como respaldo) -->
          <div class="rounded-xl border border-slate-100 bg-slate-50/60 p-4 space-y-3">
            <div class="flex items-center gap-2">
              <div class="p-1.5 rounded-lg bg-emerald-100 text-emerald-600">
                <i class="fa-solid fa-clipboard-check text-[11px]"></i>
              </div>
              <div>
                <div class="text-xs font-semibold text-slate-900">
                  Marcar asistencias (IDs manual)
                </div>
                <div class="text-[11px] text-slate-500">
                  Como respaldo, puedes ingresar IDs de sesiÃ³n separados por coma
                </div>
              </div>
            </div>

            <textarea
              rows="3"
              class="w-full rounded-lg border border-slate-300 bg-white px-2.5 py-1.5 text-[12px] resize-none"
              [ngModel]="sesionIdsTexto()"
              (ngModelChange)="sesionIdsTexto.set($event)"
              placeholder="Ej: 1001, 1002, 1003"></textarea>

            <button
              type="button"
              (click)="marcarAsistenciasDesdeTexto()"
              [disabled]="loading()"
              class="inline-flex items-center gap-2 rounded-lg bg-emerald-600 px-3 py-1.5 text-[12px] font-semibold text-white hover:bg-emerald-700 disabled:opacity-50">
              <i class="fa-solid fa-check-double"></i>
              Marcar asistencias
            </button>
          </div>

          <!-- Inscribir en evento -->
          <div class="rounded-xl border border-slate-100 bg-slate-50/60 p-4 space-y-3">
            <div class="flex items-center gap-2">
              <div class="p-1.5 rounded-lg bg-indigo-100 text-indigo-600">
                <i class="fa-solid fa-calendar-plus text-[11px]"></i>
              </div>
              <div>
                <div class="text-xs font-semibold text-slate-900">
                  Inscribir en evento
                </div>
                <div class="text-[11px] text-slate-500">
                  Ingresa el ID del evento configurado en el mÃ³dulo de eventos
                </div>
              </div>
            </div>

            <div class="space-y-2">
              <label class="block text-[11px] font-semibold text-slate-700">
                ID de evento
              </label>
              <input
                type="number"
                class="w-full rounded-lg border border-slate-300 bg-white px-2.5 py-1.5 text-[13px]"
                [ngModel]="eventoIdManual() ?? ''"
                (ngModelChange)="eventoIdManual.set($event ? +$event : null)"
                placeholder="Ej: 42" />
            </div>

            <button
              type="button"
              (click)="inscribirEventoManual()"
              [disabled]="loading() || !eventoIdManual()"
              class="inline-flex items-center gap-2 rounded-lg bg-indigo-600 px-3 py-1.5 text-[12px] font-semibold text-white hover:bg-indigo-700 disabled:opacity-50">
              <i class="fa-solid fa-user-plus"></i>
              Inscribir en evento
            </button>
          </div>
        </div>
      </section>

    </section>

    <!-- Mensaje inicial cuando no hay datos -->
    <section *ngIf="!tieneDatos() && !loading()" class="rounded-2xl border border-dashed border-slate-200 bg-white/70 p-6 text-center text-sm text-slate-500">
      Busca un alumno por cÃ³digo o ID de expediente para ver su informaciÃ³n acadÃ©mica, horas VCM,
      proyectos y eventos, y gestionarlos desde este panel.
    </section>

    <!-- Loader global -->
    <div *ngIf="loading()" class="fixed inset-0 bg-white/70 backdrop-blur-sm z-50 grid place-items-center">
      <div class="text-center">
        <div class="relative mx-auto">
          <div class="w-14 h-14 rounded-full border-4 border-slate-200"></div>
          <div class="absolute inset-0 w-14 h-14 animate-spin rounded-full border-4 border-violet-600 border-t-transparent"></div>
        </div>
        <div class="mt-3 text-sm font-semibold text-slate-900">Procesando...</div>
      </div>
    </div>

  </main>
</div>
