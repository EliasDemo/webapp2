<div
  class="relative flex min-h-screen items-center justify-center bg-slate-950 px-4 py-6 sm:px-6 lg:px-8 overflow-hidden"
>
  <!-- Fondos decorativos -->
  <div
    class="pointer-events-none absolute inset-x-0 top-0 h-64 bg-gradient-to-b from-red-500/30 via-red-500/5 to-transparent"
  ></div>
  <div
    class="pointer-events-none absolute -right-24 bottom-0 h-64 w-64 rounded-full bg-red-500/20 blur-3xl"
  ></div>
  <div
    class="pointer-events-none absolute -left-24 top-10 h-64 w-64 rounded-full bg-amber-400/10 blur-3xl"
  ></div>

  <div class="relative w-full max-w-5xl">
    <div
      class="relative flex max-h-[calc(100vh-2rem)] flex-col overflow-hidden rounded-3xl border border-slate-800 bg-slate-950/90 shadow-2xl backdrop-blur-xl lg:grid lg:max-h-[calc(100vh-3rem)] lg:grid-cols-[minmax(0,1.1fr)_minmax(0,1fr)]"
    >
      <!-- PANEL IZQUIERDO: MARCA (se muestra en lg+) -->
      <aside
        class="relative hidden flex-col justify-between gap-8 bg-gradient-to-br from-red-800 via-red-700 to-slate-900 px-8 py-8 text-slate-50 lg:flex"
      >
        <img
          src="assets/peru.jpg"
          alt="Campus UPeU"
          class="pointer-events-none absolute inset-0 h-full w-full object-cover opacity-40 mix-blend-soft-light"
        />
        <div
          class="pointer-events-none absolute inset-0 bg-gradient-to-br from-red-900/85 via-red-900/45 to-slate-950/95"
        ></div>

        <div class="relative space-y-6">
          <div class="flex items-center gap-3">
            <img
              src="https://upeu.edu.pe/wp-content/uploads/2022/04/logo-upeu-dark-svg.svg"
              alt="UPeU"
              class="h-10 w-auto drop-shadow-[0_10px_25px_rgba(15,23,42,0.7)] invert"
              onerror="this.style.display='none'"
            />
            <div
              class="inline-flex max-w-xs items-center rounded-full border border-red-100/70 bg-black/20 px-3 py-1 text-[0.65rem] font-semibold uppercase tracking-[0.17em]"
            >
              <span class="line-clamp-1">
                {{
                  step() === 1
                    ? 'Universidad Peruana Uni√≥n'
                    : (sede() || 'Universidad Peruana Uni√≥n')
                }}
              </span>
            </div>
          </div>

          <div class="space-y-4">
            <h2 class="text-xl font-semibold leading-tight sm:text-2xl">
              Plataforma de Vinculaci√≥n con el Medio
            </h2>
            <p class="max-w-md text-sm text-red-50/90">
              Accede a tus proyectos, eventos, registros y certificados en un
              solo lugar, con tu usuario institucional UPeU.
            </p>

            <ul
              class="space-y-2 text-sm text-red-50/90"
              aria-label="Caracter√≠sticas principales"
            >
              <li class="flex items-center gap-2">
                <span
                  class="inline-flex h-1.5 w-1.5 rounded-full bg-amber-300 drop-shadow-[0_0_12px_rgba(251,191,36,0.9)]"
                ></span>
                Gesti√≥n de proyectos y eventos institucionales.
              </li>
              <li class="flex items-center gap-2">
                <span
                  class="inline-flex h-1.5 w-1.5 rounded-full bg-amber-300 drop-shadow-[0_0_12px_rgba(251,191,36,0.9)]"
                ></span>
                Control de asistencia y participaci√≥n estudiantil.
              </li>
              <li class="flex items-center gap-2">
                <span
                  class="inline-flex h-1.5 w-1.5 rounded-full bg-amber-300 drop-shadow-[0_0_12px_rgba(251,191,36,0.9)]"
                ></span>
                Integraci√≥n con expedientes acad√©micos UPeU.
              </li>
            </ul>
          </div>
        </div>

        <div class="relative text-xs text-red-100/80">
          <p class="font-medium">
            {{ fullName() || 'Inicia sesi√≥n con tu cuenta institucional' }}
          </p>
          <p class="text-red-100/60">
            Tu acceso est√° protegido. No compartas tus credenciales.
          </p>
        </div>
      </aside>

      <!-- PANEL DERECHO: LOGIN -->
      <main
        class="flex flex-1 items-stretch bg-slate-950/95"
      >
        <div
          class="flex w-full flex-col items-center justify-center px-4 py-6 sm:px-6 lg:px-8"
        >
          <div
            class="w-full max-w-md overflow-y-auto rounded-2xl bg-slate-900/80 p-5 shadow-xl ring-1 ring-slate-800/60 sm:rounded-3xl sm:p-7 lg:max-h-[calc(100vh-6rem)]"
          >
            <!-- HEADER -->
            <header class="space-y-4">
              <!-- Logo + chip -->
              <div class="flex items-center justify-between gap-3">
                <div class="flex items-center gap-3">
                  <img
                    src="https://upeu.edu.pe/wp-content/uploads/2022/04/logo-upeu-dark-svg.svg"
                    alt="UPeU"
                    class="h-8 w-auto rounded-md bg-slate-900/80 p-1.5 shadow-sm shadow-slate-900/80"
                    onerror="this.style.display='none'"
                  />
                  <span
                    class="hidden rounded-full bg-slate-900/90 px-3 py-1 text-[0.65rem] font-semibold uppercase tracking-[0.18em] text-slate-400 sm:inline-flex"
                  >
                    {{
                      lang === 'es'
                        ? 'Acceso institucional'
                        : 'Institutional Access'
                    }}
                  </span>
                </div>
                <p
                  class="text-[0.7rem] font-medium uppercase tracking-[0.22em] text-slate-500"
                >
                  {{ step() === 1 ? 'Paso 1 de 2' : 'Paso 2 de 2' }}
                </p>
              </div>

              <div class="space-y-1">
                <h1
                  class="text-xl font-semibold tracking-tight text-slate-50 sm:text-2xl"
                >
                  {{ title() }}
                </h1>
                <p class="text-sm text-slate-400">
                  {{
                    step() === 1
                      ? 'Usa tu usuario institucional (sin @upeu.edu.pe) para continuar.'
                      : 'Confirma tu identidad con tu contrase√±a personal.'
                  }}
                </p>
              </div>

              <!-- Stepper mejorado -->
              <div
                class="mt-1 flex items-center gap-2 rounded-full border border-slate-800 bg-slate-900/80 p-1 text-xs font-medium text-slate-400"
              >
                <div class="flex-1">
                  <div
                    class="flex items-center gap-1.5 rounded-full px-3 py-1.5"
                    [ngClass]="
                      step() === 1
                        ? 'bg-slate-100 text-slate-900 shadow-sm'
                        : 'text-slate-400'
                    "
                  >
                    <span
                      class="flex h-5 w-5 items-center justify-center rounded-full border text-[0.65rem]"
                      [ngClass]="
                        step() === 1
                          ? 'border-slate-900 bg-slate-900 text-slate-100'
                          : 'border-slate-600 text-slate-300'
                      "
                    >
                      1
                    </span>
                    <span class="hidden sm:inline">Usuario</span>
                    <span class="sm:hidden">User</span>
                  </div>
                </div>

                <div
                  class="hidden h-px w-8 shrink-0 bg-gradient-to-r from-slate-700/80 via-slate-600/40 to-slate-600/10 sm:block"
                ></div>

                <div class="flex-1">
                  <div
                    class="flex items-center gap-1.5 rounded-full px-3 py-1.5"
                    [ngClass]="
                      step() === 2
                        ? 'bg-slate-100 text-slate-900 shadow-sm'
                        : 'text-slate-400'
                    "
                  >
                    <span class="hidden sm:inline">Contrase√±a</span>
                    <span class="sm:hidden">Pass</span>
                    <span
                      class="flex h-5 w-5 items-center justify-center rounded-full border text-[0.65rem]"
                      [ngClass]="
                        step() === 2
                          ? 'border-slate-900 bg-slate-900 text-slate-100'
                          : 'border-slate-600 text-slate-300'
                      "
                    >
                      2
                    </span>
                  </div>
                </div>
              </div>
            </header>

            <!-- PASO 1: USERNAME -->
            <form
              *ngIf="step() === 1"
              [formGroup]="lookupForm"
              (ngSubmit)="submitLookup()"
              class="mt-6 space-y-5"
              novalidate
            >
              <!-- error global lookup -->
              <div
                *ngIf="lookupError()"
                class="flex items-start gap-2 rounded-xl border border-amber-400/60 bg-amber-500/10 px-3 py-2 text-xs text-amber-100"
                role="alert"
                aria-live="polite"
              >
                <span class="mt-0.5 text-lg">‚ö†Ô∏è</span>
                <p class="leading-snug">
                  {{ lookupError() }}
                </p>
              </div>

              <div class="space-y-2">
                <label
                  for="username"
                  class="block text-sm font-medium text-slate-200"
                >
                  Usuario institucional
                </label>
                <div class="relative">
                  <input
                    id="username"
                    formControlName="username"
                    autocomplete="username"
                    placeholder="ej. nombre.apellido"
                    (input)="onUsernameChange()"
                    class="block w-full rounded-xl border bg-slate-900/70 px-3 py-2.5 text-sm text-slate-50 placeholder-slate-500 shadow-sm outline-none transition disabled:cursor-not-allowed"
                    [ngClass]="{
                      'border-slate-700 focus:border-amber-400 focus:ring-2 focus:ring-amber-400/40':
                        !(lookupError() || (username.invalid && username.touched)),
                      'border-red-500/70 bg-red-950/40 focus:border-red-400 focus:ring-2 focus:ring-red-500/40':
                        lookupError() || (username.invalid && username.touched)
                    }"
                    [attr.aria-invalid]="
                      username.invalid && username.touched ? 'true' : 'false'
                    "
                  />
                  <span
                    class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-[0.75rem] text-slate-500"
                  >
                    @upeu.edu.pe
                  </span>
                </div>
                <p
                  class="text-[0.7rem] text-red-400"
                  *ngIf="username.invalid && username.touched && !lookupError()"
                  aria-live="polite"
                >
                  Este campo es obligatorio.
                </p>
                <p class="text-[0.72rem] text-slate-400">
                  Solo escribe tu usuario, sin el dominio
                  <span class="font-semibold">@upeu.edu.pe</span>.
                </p>
              </div>

              <button
                type="submit"
                class="inline-flex w-full items-center justify-center gap-2 rounded-xl bg-gradient-to-r from-red-600 via-red-500 to-amber-500 px-4 py-2.5 text-sm font-semibold text-slate-50 shadow-lg shadow-red-900/40 transition hover:brightness-110 hover:shadow-red-900/60 disabled:cursor-not-allowed disabled:bg-slate-700 disabled:text-slate-400 disabled:shadow-none"
                [disabled]="lookupForm.invalid || loadingLookup()"
              >
                <span *ngIf="!loadingLookup()">Continuar</span>
                <span
                  *ngIf="loadingLookup()"
                  class="inline-flex items-center gap-2"
                >
                  <span
                    class="h-4 w-4 animate-spin rounded-full border-2 border-slate-100 border-t-transparent"
                  ></span>
                  Verificando‚Ä¶
                </span>
              </button>
            </form>

            <!-- PASO 2: PASSWORD -->
            <form
              *ngIf="step() === 2"
              [formGroup]="loginForm"
              (ngSubmit)="submitLogin()"
              class="mt-6 space-y-5"
              novalidate
            >
              <!-- Resumen de usuario -->
              <div
                class="flex items-center gap-3 rounded-2xl border border-slate-800 bg-slate-900/70 px-3.5 py-3"
              >
                <div
                  class="flex h-10 w-10 items-center justify-center overflow-hidden rounded-full bg-gradient-to-br from-red-500 to-amber-400 text-sm font-semibold text-slate-900"
                >
                  <img
                    [src]="profilePhoto() || 'assets/photo.svg'"
                    alt="Foto de perfil"
                    class="h-full w-full object-cover"
                  />
                </div>
                <div class="min-w-0 flex-1">
                  <p class="truncate text-sm font-semibold text-slate-50">
                    {{ fullName() || username.value }}
                  </p>
                  <p class="truncate text-xs text-slate-400">
                    <ng-container *ngIf="escuela()">{{ escuela() }} ¬∑ </ng-container>
                    {{ rol() || 'Usuario' }}
                  </p>
                </div>
                <button
                  type="button"
                  class="text-[0.7rem] font-medium text-amber-300 underline-offset-2 hover:underline"
                  (click)="back()"
                >
                  Cambiar
                </button>
              </div>

              <!-- Mensaje de bloqueo -->
              <div
                *ngIf="isLocked()"
                class="flex gap-3 rounded-2xl border border-red-500/40 bg-red-950/60 px-3.5 py-3 text-sm text-red-100"
                role="alert"
                aria-live="assertive"
              >
                <div
                  class="flex h-9 w-9 items-center justify-center rounded-full bg-red-500/20 text-lg"
                >
                  üîí
                </div>
                <div class="space-y-1">
                  <p
                    class="text-xs font-semibold uppercase tracking-[0.18em] text-red-300"
                  >
                    Cuenta bloqueada
                  </p>
                  <p class="text-xs leading-snug">
                    {{ loginError() }}
                  </p>
                </div>
              </div>

              <!-- Error global de login (no bloqueado) -->
              <div
                *ngIf="loginError() && !isLocked()"
                class="flex gap-2 rounded-xl border border-red-500/50 bg-red-900/40 px-3 py-2 text-xs text-red-100"
                role="alert"
                aria-live="polite"
              >
                <span class="mt-0.5 text-base">‚ö†Ô∏è</span>
                <p class="leading-snug">
                  {{ loginError() }}
                </p>
              </div>

              <!-- Campo contrase√±a -->
              <div class="space-y-2">
                <label
                  for="password"
                  class="block text-sm font-medium text-slate-200"
                >
                  Contrase√±a
                </label>
                <div class="relative">
                  <input
                    [type]="showPassword() ? 'text' : 'password'"
                    id="password"
                    formControlName="password"
                    autocomplete="current-password"
                    placeholder="Ingresa tu contrase√±a"
                    [disabled]="isLocked()"
                    (input)="onPasswordChange()"
                    class="block w-full rounded-xl border bg-slate-900/70 px-3 py-2.5 text-sm text-slate-50 placeholder-slate-500 shadow-sm outline-none transition disabled:cursor-not-allowed disabled:border-slate-800 disabled:text-slate-500"
                    [ngClass]="{
                      'border-slate-800 focus:border-amber-400 focus:ring-2 focus:ring-amber-400/40':
                        !loginError() || isLocked(),
                      'border-red-500/70 bg-red-950/50 focus:border-red-400 focus:ring-2 focus:ring-red-500/40':
                        loginError() && !isLocked()
                    }"
                    [attr.aria-invalid]="
                      (password.invalid && password.touched) || loginError()
                        ? 'true'
                        : 'false'
                    "
                  />

                  <button
                    type="button"
                    class="absolute inset-y-0 right-2 flex items-center rounded-full px-2 text-lg transition hover:bg-slate-800/70 disabled:opacity-40"
                    (click)="togglePasswordVisibility()"
                    [disabled]="isLocked()"
                    tabindex="-1"
                  >
                    <span>{{ showPassword() ? 'üôà' : 'üëÅÔ∏è' }}</span>
                  </button>
                </div>

                <p
                  class="text-[0.75rem] text-red-400"
                  *ngIf="password.invalid && password.touched"
                  aria-live="polite"
                >
                  La contrase√±a es requerida.
                </p>

                <div class="flex justify-end">
                  <a
                    href="#"
                    class="text-xs font-medium text-slate-400 underline-offset-2 hover:text-amber-300 hover:underline"
                    (click)="requestPasswordReset(); $event.preventDefault()"
                  >
                    ¬øOlvidaste tu contrase√±a?
                  </a>
                </div>
              </div>

              <div class="flex gap-3 pt-1">
                <button
                  type="button"
                  class="inline-flex flex-1 items-center justify-center rounded-xl border border-slate-700 bg-slate-900/70 px-4 py-2.5 text-sm font-medium text-slate-200 shadow-sm transition hover:border-slate-500 hover:bg-slate-900"
                  (click)="back()"
                  [disabled]="loadingLogin()"
                >
                  Cambiar usuario
                </button>

                <button
                  type="submit"
                  class="inline-flex flex-1 items-center justify-center gap-2 rounded-xl bg-gradient-to-r from-red-600 via-red-500 to-amber-500 px-4 py-2.5 text-sm font-semibold text-slate-50 shadow-lg shadow-red-900/40 transition hover:brightness-110 hover:shadow-red-900/60 disabled:cursor-not-allowed disabled:bg-slate-700 disabled:text-slate-400 disabled:shadow-none"
                  [disabled]="loginForm.invalid || isLocked() || loadingLogin()"
                >
                  <ng-container *ngIf="!loadingLogin()">
                    {{ isLocked() ? 'Cuenta bloqueada' : 'Ingresar' }}
                  </ng-container>
                  <ng-container *ngIf="loadingLogin()">
                    <span
                      class="h-4 w-4 animate-spin rounded-full border-2 border-slate-50 border-t-transparent"
                    ></span>
                    <span>Ingresando‚Ä¶</span>
                  </ng-container>
                </button>
              </div>
            </form>

            <!-- FOOTER -->
            <footer class="mt-6 border-t border-slate-800/80 pt-4">
              <p class="text-center text-[0.72rem] text-slate-500">
                ¬øNecesitas ayuda?
                <a
                  href="#"
                  class="font-medium text-amber-300 underline-offset-2 hover:underline"
                  >Cont√°ctanos</a
                >
              </p>
            </footer>
          </div>
        </div>
      </main>
    </div>
  </div>
</div>
