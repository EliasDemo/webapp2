import{a as Ve}from"./chunk-IZ77CWTJ.js";import{B as we,a as ge,b as ve,c as y,d as he,e as fe,j as _e,k as be,n as xe,o as ye,p as Ce,q as Ee,r as Se,s as Pe,t as Ae,u as Ie,v as Fe,z as Ne}from"./chunk-J2XPQYKK.js";import{a as Me}from"./chunk-QG2H74YZ.js";import"./chunk-LWNR2F3M.js";import{f as pe}from"./chunk-5VQTM22E.js";import{i as le,j as de,k as ce,s as ue,u as me}from"./chunk-FE5WSVYG.js";import{$ as X,$a as s,Fb as A,Gb as k,Hb as z,Ib as oe,Ka as ne,Kb as Y,Mb as J,Ob as se,Pa as v,T as U,Tb as ae,Y as M,Z as V,_ as q,_a as m,ab as o,bb as S,eb as $,fa as N,fb as B,gb as L,kb as I,mb as u,n as T,rb as re,sb as K,tb as H,ua as ie,vb as a,wb as w,xb as E,ya as d,yb as Q}from"./chunk-63T4HJ2B.js";import{a as G}from"./chunk-IMPBB4AK.js";var Oe=()=>["ep_sede_id"],ke=()=>["periodo_id"],ze=()=>["titulo"],Le=()=>["descripcion"],He=()=>["tipo"],We=()=>["modalidad"],Re=()=>["horas_planificadas"],Ze=(r,i)=>({"text-red-600":r,"text-gray-600":i}),Ue=()=>["niveles"],et=(r,i,e)=>({"text-red-600":r,"text-amber-600":i,"text-gray-500":e}),$e=r=>["procesos",r,"nombre"],Be=r=>["procesos",r,"tipo_registro"],qe=r=>["procesos",r,"horas_asignadas"],je=r=>["procesos",r,"nota_minima"],tt=(r,i)=>({"text-red-600":r,"text-gray-500":i}),Ge=(r,i)=>["procesos",r,"sesiones",i,"fecha"],Xe=(r,i)=>["procesos",r,"sesiones",i,"hora_inicio"],Ke=(r,i)=>["procesos",r,"sesiones",i,"hora_fin"],Qe=()=>[];function it(r,i){if(r&1&&(s(0,"div",55)(1,"div",61),q(),s(2,"svg",62),S(3,"path",63),o(),a(4),o()()),r&2){let e=u();d(4),E(" ",e.serverErr()," ")}}function nt(r,i){if(r&1&&(s(0,"option",27),a(1),o()),r&2){let e=i.$implicit;m("ngValue",e.value),d(),w(e.label)}}function rt(r,i){if(r&1&&(s(0,"p",64),a(1),o()),r&2){let e=u();d(),E(" ",e.getSvr(A(1,Oe))||"Selecciona una EP_SEDE"," ")}}function ot(r,i){if(r&1&&(s(0,"option",27),a(1),o()),r&2){let e=i.$implicit;m("ngValue",e.value),d(),w(e.label)}}function st(r,i){if(r&1&&(s(0,"p",64),a(1),o()),r&2){let e=u();d(),E(" ",e.getSvr(A(1,ke))||"Selecciona un per\xEDodo"," ")}}function at(r,i){if(r&1&&(s(0,"p",64),a(1),o()),r&2){let e=u();d(),E(" ",e.getSvr(A(1,ze))||"M\xEDnimo 3 caracteres"," ")}}function lt(r,i){if(r&1&&(s(0,"p",64),a(1),o()),r&2){let e=u();d(),w(e.getSvr(A(1,Le)))}}function dt(r,i){if(r&1&&(s(0,"p",64),a(1),o()),r&2){let e=u();d(),w(e.getSvr(A(1,He)))}}function ct(r,i){if(r&1&&(s(0,"p",64),a(1),o()),r&2){let e=u();d(),w(e.getSvr(A(1,We)))}}function ut(r,i){if(r&1&&(s(0,"p",64),a(1),o()),r&2){let e=u();d(),E(" ",e.getSvr(A(1,Re))||"M\xEDnimo 1 hora"," ")}}function mt(r,i){if(r&1&&(s(0,"div",72),a(1),o()),r&2){let e=u(2);d(),E(" ",e.nivelesLoadWarning()," ")}}function pt(r,i){if(r&1){let e=L();s(0,"label",75)(1,"input",76),I("change",function(n){let l=M(e).$implicit,c=u(3);return V(c.toggleNivel(l,n.target.checked))}),o(),s(2,"span",77),a(3),o()()}if(r&2){let e=i.$implicit,t=u(3);d(),m("checked",t.isNivelSelected(e)),d(2),E("Ciclo ",e)}}function gt(r,i){if(r&1&&(s(0,"div",73),v(1,pt,4,2,"label",74),o()),r&2){let e=u(2);d(),m("ngForOf",e.nivelesDisponibles())}}function vt(r,i){r&1&&(s(0,"div",78),a(1," No hay ciclos habilitados para esta sede/per\xEDodo o no se pudo cargar la disponibilidad. "),o())}function ht(r,i){r&1&&(s(0,"span"),a(1,", "),o())}function ft(r,i){if(r&1&&($(0),a(1),v(2,ht,2,0,"span",42),B()),r&2){let e=i.$implicit,t=i.last;d(),E(" C",e),d(),m("ngIf",!t)}}function _t(r,i){if(r&1&&(s(0,"div",79),a(1," No disponibles por otro proyecto: "),v(2,ft,3,2,"ng-container",80),a(3,". Cambia el per\xEDodo o desmarca esos ciclos. "),o()),r&2){let e=u(2);d(2),m("ngForOf",e.nivelesBloqueadosSrv())}}function bt(r,i){if(r&1&&(s(0,"p",64),a(1),o()),r&2){let e=u(2);d(),E(" ",e.getSvr(A(1,Ue))||"Selecciona al menos un ciclo"," ")}}function xt(r,i){if(r&1){let e=L();s(0,"div")(1,"label",65),a(2,"Ciclos acad\xE9micos (puedes elegir varios)"),o(),v(3,mt,2,1,"div",66)(4,gt,2,1,"div",67)(5,vt,2,0,"ng-template",null,0,se)(7,_t,4,1,"div",68),s(8,"div",69)(9,"button",70),I("click",function(){M(e);let n=u();return V(n.selectAllNiveles())}),a(10,"Seleccionar todos"),o(),s(11,"button",71),I("click",function(){M(e);let n=u();return V(n.clearNiveles())}),a(12,"Limpiar"),o()(),v(13,bt,2,2,"p",29),o()}if(r&2){let e=re(6),t=u();d(3),m("ngIf",t.nivelesLoadWarning()),d(),m("ngIf",t.nivelesDisponibles().length)("ngIfElse",e),d(3),m("ngIf",t.nivelesBloqueadosSrv().length),d(2),m("disabled",!t.nivelesDisponibles().length),d(4),m("ngIf",t.nivelesInvalid()&&t.nivelesDisponibles().length>0||t.getSvr(A(6,Ue)))}}function yt(r,i){if(r&1){let e=L();s(0,"div",83),S(1,"img",84),s(2,"button",85),I("click",function(){let n=M(e).index,l=u(2);return V(l.removeImage(n))}),a(3," Quitar "),o()()}if(r&2){let e=i.$implicit;d(),m("src",e.preview,ie)}}function Ct(r,i){if(r&1&&(s(0,"div",81),v(1,yt,4,1,"div",82),o()),r&2){let e=u();d(),m("ngForOf",e.imagenes())}}function Et(r,i){if(r&1&&($(0),a(1," \xB7 Plan por ciclo: "),s(2,"b"),a(3),o(),a(4),B()),r&2){let e=u();d(3),w(e.form.get("horas_planificadas").value),d(),E(" h \xD7 ",e.nivelesCtrl.value.length," ")}}function St(r,i){if(r&1&&(s(0,"div",90)(1,"div",91)(2,"div",92),a(3),o(),s(4,"div",87),a(5),o()(),s(6,"div",93),S(7,"div",94),o(),s(8,"div",95),a(9),Y(10,"number"),o()()),r&2){let e=i.$implicit,t=u(2);d(3),E("Ciclo ",e),d(2),Q(" ",t.perNivelUsadasHoras(e)," / ",t.form.get("horas_planificadas").value," h "),d(2),K("width",t.perNivelPct(e),"%"),m("ngClass",t.nivelBarClass(e)),d(),m("ngClass",oe(11,et,t.perNivelRestanteMin(e)<=0,t.perNivelRestanteMin(e)>0&&t.perNivelRestanteMin(e)<t.planMin(),t.perNivelRestanteMin(e)>=t.planMin())),d(),E(" Restan ",J(10,8,t.perNivelRestanteMin(e)/60,"1.0-2")," h ")}}function Pt(r,i){if(r&1&&(s(0,"div",86)(1,"div",87),a(2,"Distribuci\xF3n por ciclo"),o(),s(3,"div",88),v(4,St,11,15,"div",89),o()()),r&2){let e=u();d(4),m("ngForOf",e.nivelesCtrl.value)}}function At(r,i){r&1&&(s(0,"div",96),a(1," Modo "),s(2,"b"),a(3,"EVALUACI\xD3N"),o(),a(4,": s\xF3lo 1 proceso y 1 sesi\xF3n. Las horas asignadas se fijan a las horas planificadas del proyecto. Rango de nota: 1\u201320. "),o())}function It(r,i){if(r&1&&(s(0,"p",64),a(1),o()),r&2){let e=u().index,t=u();d(),w(t.getSvr(k(1,$e,e)))}}function Ft(r,i){if(r&1&&(s(0,"p",64),a(1),o()),r&2){let e=u(2).index,t=u();d(),E(" ",t.getSvr(k(1,qe,e))," ")}}function Nt(r,i){if(r&1&&(s(0,"div"),S(1,"input",119),v(2,Ft,2,3,"p",29),o()),r&2){let e=u().index,t=u();d(2),m("ngIf",t.getSvr(k(1,qe,e)))}}function wt(r,i){if(r&1&&(s(0,"p",64),a(1),o()),r&2){let e=u().index,t=u();d(),w(t.getSvr(k(1,Be,e)))}}function Mt(r,i){r&1&&(s(0,"span",120),a(1," (forzado por el tipo) "),o())}function Vt(r,i){if(r&1&&(s(0,"p",64),a(1),o()),r&2){let e=u(2).index,t=u();d(),E(" ",t.getSvr(k(1,je,e))," ")}}function Tt(r,i){if(r&1&&(s(0,"div"),S(1,"input",121),v(2,Vt,2,3,"p",29),o()),r&2){let e=u().index,t=u();d(2),m("ngIf",t.getSvr(k(1,je,e)))}}function Dt(r,i){r&1&&($(0),a(1," \xB7 "),s(2,"b"),a(3,"Excede lo asignado"),o(),B())}function Ot(r,i){if(r&1&&(s(0,"div",95),a(1," En sesiones: "),s(2,"b"),a(3),o(),a(4," h / Asignadas: "),s(5,"b"),a(6),o(),a(7," h "),v(8,Dt,4,0,"ng-container",42),o()),r&2){let e=u().index,t=u();m("ngClass",z(4,tt,t.usedMinutesProceso(e)>t.getHorasAsignadas(e)*60,t.usedMinutesProceso(e)<=t.getHorasAsignadas(e)*60)),d(3),w(t.usedHoursProceso(e)),d(3),w(t.getHorasAsignadas(e)),d(2),m("ngIf",t.usedMinutesProceso(e)>t.getHorasAsignadas(e)*60)}}function kt(r,i){if(r&1&&(s(0,"p",64),a(1),o()),r&2){let e=u().index,t=u().index,n=u();d(),E(" ",n.getSvr(z(1,Ge,t,e))," ")}}function zt(r,i){if(r&1&&(s(0,"p",64),a(1),o()),r&2){let e=u().index,t=u().index,n=u();d(),E(" ",n.getSvr(z(1,Xe,t,e))," ")}}function Lt(r,i){if(r&1&&(s(0,"p",64),a(1),o()),r&2){let e=u().index,t=u().index,n=u();d(),E(" ",n.getSvr(z(1,Ke,t,e))," ")}}function Ht(r,i){if(r&1){let e=L();s(0,"label",134)(1,"input",135),I("change",function(n){let l=M(e).$implicit,c=u(2).index,p=u().index,g=u();return V(g.toggleNivelSesion(p,c,l,n.target.checked))}),o(),s(2,"span",136),a(3),o()()}if(r&2){let e=i.$implicit,t=u(2),n=t.$implicit,l=t.index,c=u().index,p=u();m("ngClass",p.nivelChipClass(e,c,l)),d(),m("checked",(n.get("niveles").value||A(4,Qe)).includes(e))("disabled",p.nivelChipDisabled(e,c,l)),d(2),E("Ciclo ",e)}}function Wt(r,i){if(r&1&&($(0),s(1,"span",137),a(2),Y(3,"number"),o(),B()),r&2){let e=i.$implicit,t=u(4);d(2),Q("C",e,": ",J(3,2,t.perNivelRestanteMin(e)/60,"1.0-2")," h libres")}}function Rt(r,i){if(r&1&&(s(0,"div",130)(1,"div",131),a(2,"Ciclos de esta sesi\xF3n"),o(),s(3,"div",73),v(4,Ht,4,5,"label",132),o(),s(5,"div",133),v(6,Wt,4,5,"ng-container",80),o()()),r&2){let e=u(),t=e.$implicit,n=e.index,l=u().index,c=u();d(4),m("ngForOf",c.nivelesOpcionesParaSesion(l,n)),d(2),m("ngForOf",t.get("niveles").value||A(2,Qe))}}function Ut(r,i){if(r&1){let e=L();s(0,"div",122)(1,"div")(2,"label",123),a(3,"Fecha"),o(),S(4,"input",124),v(5,kt,2,4,"p",29),o(),s(6,"div")(7,"label",123),a(8,"Inicio"),o(),S(9,"input",125),v(10,zt,2,4,"p",29),o(),s(11,"div")(12,"label",123),a(13,"Fin"),o(),S(14,"input",126),v(15,Lt,2,4,"p",29),o(),s(16,"div")(17,"label",123),a(18,"Duraci\xF3n (h)"),o(),S(19,"input",127),o(),v(20,Rt,7,3,"div",128),s(21,"div")(22,"button",129),I("click",function(){let n=M(e).index,l=u().index,c=u();return V(c.removeSesion(l,n))}),a(23,"Quitar"),o()()()}if(r&2){let e=i.index,t=u().index,n=u();m("formGroupName",e),d(5),m("ngIf",n.getSvr(z(5,Ge,t,e))),d(5),m("ngIf",n.getSvr(z(8,Xe,t,e))),d(5),m("ngIf",n.getSvr(z(11,Ke,t,e))),d(5),m("ngIf",n.tipo()==="VINCULADO"&&((n.nivelesCtrl.value==null?null:n.nivelesCtrl.value.length)||0)>=1)}}function $t(r,i){if(r&1){let e=L();s(0,"div",97)(1,"div",98)(2,"div"),S(3,"input",99),v(4,It,2,3,"p",29),o(),v(5,Nt,3,3,"div",42),s(6,"div")(7,"select",100)(8,"option",101),a(9,"HORAS"),o(),s(10,"option",102),a(11,"ASISTENCIA"),o(),s(12,"option",103),a(13,"EVALUACION"),o(),s(14,"option",104),a(15,"MIXTO"),o()(),v(16,wt,2,3,"p",29),o(),s(17,"div",105)(18,"label",106),S(19,"input",107),a(20," Requiere asistencia "),o(),v(21,Mt,2,0,"span",108),o(),v(22,Tt,3,3,"div",42),o(),v(23,Ot,9,7,"div",109),S(24,"textarea",110),s(25,"div",111)(26,"div",91)(27,"h4",112),a(28,"Sesiones"),o(),s(29,"button",113),I("click",function(){let n=M(e).index,l=u();return V(l.addSesion(n))}),a(30," Agregar sesi\xF3n "),o()(),s(31,"div",114),v(32,Ut,24,14,"div",115),o(),s(33,"p",116),a(34," Usa rangos v\xE1lidos (fin > inicio), sin cruzar medianoche. Si el proceso es HORAS/MIXTO, la suma de duraciones no puede exceder las horas asignadas. "),o()(),s(35,"div",117)(36,"button",118),I("click",function(){let n=M(e).index,l=u();return V(l.removeProceso(n))}),a(37,"Eliminar proceso"),o()()()}if(r&2){let e=i.index,t=u();m("formGroupName",e),d(4),m("ngIf",t.getSvr(k(15,$e,e))),d(),m("ngIf",t.procesosFA.at(e).get("horas_asignadas").enabled),d(11),m("ngIf",t.getSvr(k(17,Be,e))),d(5),m("ngIf",t.procesosFA.at(e).get("requiere_asistencia").disabled),d(),m("ngIf",t.procesosFA.at(e).get("nota_minima").enabled),d(),m("ngIf",t.procesosFA.at(e).get("horas_asignadas").enabled),d(6),H("bg-indigo-600",t.canAddSesion(e))("bg-gray-300",!t.canAddSesion(e))("cursor-not-allowed",!t.canAddSesion(e)),m("disabled",!t.canAddSesion(e)),d(3),m("ngForOf",t.sesiones(e).controls)}}function Bt(r,i){if(r&1){let e=L();s(0,"div",138)(1,"div",139),I("click",function(){M(e);let n=u();return V(n.closeCancel())}),o(),s(2,"div",140)(3,"h3",49),a(4,"\xBFCancelar creaci\xF3n?"),o(),s(5,"p",141),a(6," Se perder\xE1n los cambios no guardados. Si la creaci\xF3n ya empez\xF3 en el servidor, intentar\xE9 "),s(7,"span",142),a(8,"anular"),o(),a(9," el proyecto parcial. "),o(),s(10,"div",143)(11,"button",58),I("click",function(){M(e);let n=u();return V(n.closeCancel())}),a(12,"Seguir editando"),o(),s(13,"button",144),I("click",function(){M(e);let n=u();return V(n.confirmCancel())}),a(14),o()()()()}if(r&2){let e=u();d(13),m("disabled",e.rollingBack()),d(),E(" ",e.rollingBack()?"Anulando\u2026":"Cancelar y salir"," ")}}function Te(r){return r&&typeof r=="object"&&"data"in r&&r.ok===!0}var Z=1,ee=20,R=class R{constructor(){this.fb=U(Ne);this.api=U(Me);this.lookups=U(Ve);this.router=U(pe);this.step=N(1);this.submitting=N(!1);this.rollingBack=N(!1);this.showCancel=N(!1);this.serverErr=N(null);this.serverFieldErrors=N({});this.epOptions=N([]);this.perOptions=N([]);this.nivelesDisponibles=N([]);this.nivelesLoadWarning=N(null);this.nivelesBloqueadosSrv=N([]);this.periodosIndex={};this.imagenes=N([]);this.subscriptions=[];this.createdProyectoId=null;this.form=this.fb.group({ep_sede_id:this.fb.control(null,[y.required]),periodo_id:this.fb.control(null,[y.required]),codigo:this.fb.control(""),titulo:this.fb.control("",[y.required,y.minLength(3)]),descripcion:this.fb.control(""),tipo:this.fb.control("VINCULADO",[y.required]),modalidad:this.fb.control("PRESENCIAL",[y.required]),niveles:this.fb.control([],[]),horas_planificadas:this.fb.control(5,[y.required,y.min(1)]),procesos:this.fb.array([])});this.tipo=N("VINCULADO");this.procesos=ae(()=>this.procesosFA.controls);this.hasError=i=>!!this.form.get(i)?.invalid&&(this.form.get(i)?.touched||this.form.get(i)?.dirty);this.isNivelSelected=i=>(this.nivelesCtrl.value??[]).includes(i)}get procesosFA(){return this.form.get("procesos")}get nivelesCtrl(){return this.form.get("niveles")}toggleNivel(i,e){let t=new Set(this.nivelesCtrl.value??[]);e?t.add(i):t.delete(i),this.nivelesCtrl.setValue([...t].sort((n,l)=>n-l)),this.nivelesCtrl.markAsDirty(),this.nivelesCtrl.markAsTouched()}selectAllNiveles(){this.nivelesCtrl.setValue([...this.nivelesDisponibles()]),this.nivelesCtrl.markAsDirty(),this.nivelesCtrl.markAsTouched()}clearNiveles(){this.nivelesCtrl.setValue([]),this.nivelesCtrl.markAsDirty(),this.nivelesCtrl.markAsTouched()}nivelesInvalid(){return this.tipo()==="VINCULADO"&&!this.nivelesCtrl.disabled&&(this.nivelesCtrl.value?.length??0)===0&&(this.nivelesCtrl.touched||this.nivelesCtrl.dirty)}pathKey(i){return i.map(e=>typeof e=="number"?`[${e}]`:e).join(".")}getSvr(i){let e=this.pathKey(i),n=this.serverFieldErrors()[e];return n?.length?n[0]:null}clearServerErrors(){this.serverFieldErrors.set({})}extractServerValidation(i){let e="Datos inv\xE1lidos.",t={},n=i?.error??i;if(typeof n=="string"&&(e=n),n?.message&&(e=n.message),n?.errors&&typeof n.errors=="object")for(let[l,c]of Object.entries(n.errors)){let p=/^niveles(\.\d+)?$/i.test(l)?"niveles":String(l),g=Array.isArray(c)?c:[String(c)];(t[p]||=[]).push(...g.map(String))}if(Array.isArray(n?.violations))for(let l of n.violations){let c=/^niveles(\.\d+)?$/i.test(String(l.propertyPath))?"niveles":String(l.propertyPath||l.field||l.name||"general"),p=String(l.message||l.reason||"Inv\xE1lido");(t[c]||=[]).push(p)}if(Array.isArray(n?.fieldErrors))for(let l of n.fieldErrors){let c=/^niveles(\.\d+)?$/i.test(String(l.field))?"niveles":String(l.field||"general"),p=String(l.message||"Inv\xE1lido");(t[c]||=[]).push(p)}return Array.isArray(n?.fechas_fuera)&&n?.rango?.length===2&&(e=n.message||"Hay fechas fuera del per\xEDodo del proyecto.",(t.fechas||=[]).push(`Fuera del periodo: ${n.rango[0]} a ${n.rango[1]}.`)),{message:e,fields:t}}parseCiclosFromText(i){if(!i)return[];let e=new Set,t=/\b(?:nivel|ciclo)\s*(\d{1,2})\b/gi,n;for(;n=t.exec(i);){let l=parseInt(n[1],10);l>=1&&l<=10&&e.add(l)}return[...e]}sanitizeFecha(i){if(!i)return"";let e=String(i).trim();return e.includes("T")&&(e=e.split("T")[0]),e.includes(" ")&&(e=e.split(" ")[0]),/^\d{4}-\d{2}-\d{2}$/.test(e)?e:""}sanitizeHora(i){if(!i)return"";let e=String(i).trim(),t=e.match(/^(\d{1}):(\d{2})$/);t&&(e=`0${t[1]}:${t[2]}`);let n=e.match(/^(\d{2}):(\d{2}):\d{2}$/);return n&&(e=`${n[1]}:${n[2]}`),/^\d{2}:\d{2}$/.test(e)?e:""}hhmmToMinutes(i){if(!/^\d{2}:\d{2}$/.test(i))return null;let[e,t]=i.split(":").map(Number);return e*60+t}minutesToHhmm(i){let e=Math.floor(i/60),t=i%60;return`${String(e).padStart(2,"0")}:${String(t).padStart(2,"0")}`}diffMinutes(i,e){let t=this.hhmmToMinutes(i),n=this.hhmmToMinutes(e);return t==null||n==null?0:Math.max(0,n-t)}isHoursDriven(i){let e=this.procesosFA.at(i).get("tipo_registro").value||"HORAS";return e==="HORAS"||e==="MIXTO"}isEval(i){return(this.procesosFA.at(i).get("tipo_registro").value||"HORAS")==="EVALUACION"}hasEvaluationProcess(){return this.procesosFA.controls.some(i=>i.get("tipo_registro").value==="EVALUACION")}allowedPlanTotal(){let i=Number(this.form.get("horas_planificadas").value||0);if(this.tipo()==="VINCULADO"){let e=this.nivelesCtrl.value?.length||0;return i*(e>=2?e:1)}return i}totalAsignadas(){return this.procesosFA.controls.map((i,e)=>this.isHoursDriven(e)?Number(i.get("horas_asignadas").value||0):0).reduce((i,e)=>i+e,0)}remainingProject(){return Math.max(0,this.allowedPlanTotal()-this.totalAsignadas())}getHorasAsignadas(i){let e=this.procesosFA.at(i);return this.isHoursDriven(i)?Number(e.get("horas_asignadas").value||0):0}usedMinutesProceso(i){return this.sesiones(i).controls.map(t=>{let n=this.sanitizeHora(String(t.get("hora_inicio").value||"")),l=this.sanitizeHora(String(t.get("hora_fin").value||""));return n&&l?this.diffMinutes(n,l):0}).reduce((t,n)=>t+n,0)}usedHoursProceso(i){return+(this.usedMinutesProceso(i)/60).toFixed(2)}remainingMinutesProceso(i){if(!this.isHoursDriven(i))return Number.POSITIVE_INFINITY;let e=this.getHorasAsignadas(i)*60;return Math.max(0,e-this.usedMinutesProceso(i))}planMin(){return Number(this.form.get("horas_planificadas").value||0)*60}usedMinutesByNivel(){let i=this.nivelesCtrl.value??[],e={};i.forEach(t=>e[t]=0);for(let t=0;t<this.procesosFA.length;t++){if(!this.isHoursDriven(t))continue;let n=this.sesiones(t);for(let l of n.controls){let c=this.sanitizeHora(String(l.get("hora_inicio").value||"")),p=this.sanitizeHora(String(l.get("hora_fin").value||"")),g=c&&p?this.diffMinutes(c,p):0,f=l.get("niveles").value||[];for(let C of f)e[C]!=null&&(e[C]+=g)}}return e}perNivelUsadasHoras(i){return+((this.usedMinutesByNivel()[i]||0)/60).toFixed(2)}perNivelRestanteMin(i){let e=this.usedMinutesByNivel()[i]||0;return Math.max(0,this.planMin()-e)}perNivelPct(i){let e=this.usedMinutesByNivel()[i]||0;return Math.max(0,Math.min(100,e/this.planMin()*100||0))}nivelBarClass(i){let e=this.perNivelRestanteMin(i);return e<=0?"bg-red-500":e<this.planMin()*.2?"bg-amber-500":"bg-blue-600"}enforceCapForSession(i,e){if(!this.isHoursDriven(i))return;let t=this.sesiones(i),n=t.at(e),l=this.sanitizeHora(String(n.get("hora_inicio").value||"")),c=this.sanitizeHora(String(n.get("hora_fin").value||"")),p=l?this.hhmmToMinutes(l):null,g=c?this.hhmmToMinutes(c):null;if(p==null||g==null||g<=p)return;let f=0;t.controls.forEach((b,_)=>{if(_===e)return;let x=this.sanitizeHora(String(b.get("hora_inicio").value||"")),P=this.sanitizeHora(String(b.get("hora_fin").value||"")),F=x&&P?this.diffMinutes(x,P):0;f+=F});let C=Math.max(0,this.getHorasAsignadas(i)*60-f);if(g-p>C){let b=p+C,_=this.minutesToHhmm(Math.min(b,1439));n.get("hora_fin").setValue(_,{emitEvent:!1});let x=n.get("duracion_horas"),P=this.diffMinutes(l,_);x?.setValue(Math.max(.5,+(P/60).toFixed(2)),{emitEvent:!1})}}sesiones(i){return this.procesosFA.at(i).get("sesiones")}sessionDurationMin(i,e){let t=this.sesiones(i).at(e),n=this.sanitizeHora(String(t.get("hora_inicio").value||"")),l=this.sanitizeHora(String(t.get("hora_fin").value||""));return n&&l?this.diffMinutes(n,l):0}nivelesOpcionesParaSesion(i,e){if(this.tipo()!=="VINCULADO")return[];let t=this.nivelesCtrl.value??[],n=this.sesiones(i).at(e).get("niveles").value||[],l=this.sessionDurationMin(i,e),c=this.usedMinutesByNivel(),p=this.planMin();return t.filter(g=>Math.max(0,p-(c[g]||0)+(n.includes(g)?l:0))>0||n.includes(g))}nivelChipClass(i,e,t){if(this.tipo()!=="VINCULADO")return{};let n=this.sesiones(e).at(t).get("niveles").value||[],l=this.sessionDurationMin(e,t),c=this.usedMinutesByNivel(),p=this.planMin(),g=Math.max(0,p-(c[i]||0)+(n.includes(i)?l:0)),f=g>=l,C=g>0&&g<l,h=g<=0;return{"bg-emerald-50 border-emerald-300 text-emerald-700":f,"bg-amber-50 border-amber-300 text-amber-700":C,"bg-red-50 border-red-300 text-red-700":h}}nivelChipDisabled(i,e,t){let l=(this.sesiones(e).at(t).get("niveles").value||[]).includes(i),c=this.sessionDurationMin(e,t),p=this.usedMinutesByNivel(),g=this.planMin(),f=Math.max(0,g-(p[i]||0)+(l?c:0));return!l&&!(f>=c)}toggleNivelSesion(i,e,t,n){if(this.nivelChipDisabled(t,i,e))return;let c=this.sesiones(i).at(e).get("niveles"),p=new Set(c.value||[]);n?p.add(t):p.delete(t),c.setValue([...p].sort((g,f)=>g-f)),c.markAsDirty(),c.markAsTouched()}canAddProceso(){return!this.hasEvaluationProcess()}canAddSesion(i){return this.isEval(i)?this.sesiones(i).length<1:this.remainingMinutesProceso(i)>0}async ngOnInit(){await this.loadLookups(),this.addProceso(!0),this.tipo.set(this.form.get("tipo").value??"VINCULADO"),this.subscriptions.push(this.form.get("tipo").valueChanges.subscribe(async i=>{if(this.tipo.set(i??"VINCULADO"),this.nivelesBloqueadosSrv.set([]),i==="LIBRE"){this.nivelesCtrl.setValue([]),this.nivelesCtrl.disable({emitEvent:!1});let e=G({},this.serverFieldErrors());delete e.niveles,this.serverFieldErrors.set(e)}else{this.nivelesCtrl.enable({emitEvent:!1});let e=this.form.get("ep_sede_id").value,t=this.form.get("periodo_id").value;e&&t&&await this.loadNivelesDisponibles(e,t)}}),this.form.get("ep_sede_id").valueChanges.subscribe(async i=>{if(this.form.get("tipo").value==="VINCULADO"){let e=this.form.get("periodo_id").value;i&&e&&await this.loadNivelesDisponibles(i,e)}}),this.form.get("periodo_id").valueChanges.subscribe(async i=>{if(this.form.get("tipo").value==="VINCULADO"){let e=this.form.get("ep_sede_id").value;e&&i&&await this.loadNivelesDisponibles(e,i)}}))}ngOnDestroy(){this.subscriptions.forEach(i=>i.unsubscribe()),this.imagenes().forEach(i=>URL.revokeObjectURL(i.preview))}onFilesSelected(i){let e=i.target,t=e.files;if(!t)return;let n=[];Array.from(t).forEach(l=>{l.type.startsWith("image/")&&(l.size>5*1024*1024||n.push({file:l,preview:URL.createObjectURL(l)}))}),this.imagenes.set([...this.imagenes(),...n]),e.value=""}removeImage(i){let e=this.imagenes()[i];e&&URL.revokeObjectURL(e.preview),this.imagenes.set(this.imagenes().filter((t,n)=>n!==i))}async goNext(){this.serverErr.set(null),this.clearServerErrors(),this.form.markAllAsTouched();let i=["ep_sede_id","periodo_id","titulo","horas_planificadas"];if(this.tipo()==="VINCULADO"&&!this.nivelesCtrl.value?.length){this.nivelesCtrl.markAsTouched();return}i.some(e=>this.form.get(e).invalid)||this.step.set(2)}addProceso(i=!1){let e=this.fb.group({nombre:this.fb.control(i?"Proceso Principal":`Proceso ${this.procesosFA.length+1}`,[y.required,y.minLength(3)]),horas_asignadas:this.fb.control(1,[y.min(1)]),tipo_registro:this.fb.control("HORAS",[y.required]),nota_minima:this.fb.control(null),descripcion:this.fb.control(""),requiere_asistencia:this.fb.control(!1),sesiones:this.fb.array([])});this.procesosFA.push(e);let t=this.procesosFA.length-1,n=e.get("horas_asignadas"),l=e.get("tipo_registro"),c=e.get("nota_minima"),p=e.get("requiere_asistencia"),g=()=>{let h=l.value,b=Number(this.form.get("horas_planificadas").value||0);if(h==="HORAS"||h==="MIXTO"?(n.enable({emitEvent:!1}),n.setValidators([y.required,y.min(1)])):(n.setValue(h==="EVALUACION"?b:null,{emitEvent:!1}),n.clearValidators(),n.disable({emitEvent:!1})),n.updateValueAndValidity({emitEvent:!1}),h==="EVALUACION"||h==="MIXTO"?(c.enable({emitEvent:!1}),c.setValidators([y.required,y.min(Z),y.max(ee)])):(c.setValue(null,{emitEvent:!1}),c.clearValidators(),c.disable({emitEvent:!1})),c.updateValueAndValidity({emitEvent:!1}),h==="ASISTENCIA"||h==="MIXTO"?(p.setValue(!0,{emitEvent:!1}),p.disable({emitEvent:!1})):(p.setValue(!1,{emitEvent:!1}),p.disable({emitEvent:!1})),h==="EVALUACION"){let _=this.sesiones(t);for(_.length===0&&this.addSesion(t);_.length>1;)_.removeAt(_.length-1)}};g();let f=l.valueChanges.subscribe(()=>g());this.subscriptions.push(f);let C=n.valueChanges.subscribe(()=>{if(!this.isHoursDriven(t))return;let h=this.remainingMinutesProceso(t);if(h>=0)return;let b=this.sesiones(t),_=-h;for(let x=b.length-1;x>=0&&_>0;x--){let P=b.at(x),F=this.sanitizeHora(String(P.get("hora_inicio").value||"")),D=this.sanitizeHora(String(P.get("hora_fin").value||"")),W=F&&D?this.diffMinutes(F,D):0;if(W<=_)_-=W,b.removeAt(x);else{let O=(F?this.hhmmToMinutes(F)??0:0)+(W-_);P.get("hora_fin").setValue(this.minutesToHhmm(O),{emitEvent:!1}),P.get("duracion_horas")?.setValue(Math.max(.5,+((W-_)/60).toFixed(2)),{emitEvent:!1}),_=0}}});this.subscriptions.push(C)}removeProceso(i){this.procesosFA.removeAt(i)}addSesion(i){if(!this.canAddSesion(i))return;let e=this.sesiones(i),t="08:00",n=this.remainingMinutesProceso(i),l=this.isHoursDriven(i)?Math.max(30,Math.min(60,n||60)):60,c=this.minutesToHhmm((this.hhmmToMinutes(t)??480)+l),p=this.fb.group({fecha:this.fb.control("",[y.required]),hora_inicio:this.fb.control(t,[y.required,y.pattern(/^\d{2}:\d{2}$/)]),hora_fin:this.fb.control(c,[y.required,y.pattern(/^\d{2}:\d{2}$/)]),duracion_horas:this.fb.control(+(l/60).toFixed(2),[y.required,y.min(.5)]),niveles:this.fb.control([],[])});if(this.tipo()==="VINCULADO"){let x=this.usedMinutesByNivel(),P=this.planMin(),F=(this.nivelesCtrl.value??[]).filter(D=>P-(x[D]||0)>=l);p.get("niveles").setValue(F)}let g=p.get("hora_inicio"),f=p.get("hora_fin"),C=p.get("duracion_horas"),h=!1,b=()=>{if(h)return;let x=this.sanitizeHora(String(g.value||"")),P=this.sanitizeHora(String(f.value||"")),F=x&&P?this.diffMinutes(x,P):0;F>0&&(h=!0,C.setValue(+(F/60).toFixed(2),{emitEvent:!1}),h=!1)},_=()=>{if(h)return;let x=this.sanitizeHora(String(g.value||"")),P=x?this.hhmmToMinutes(x)??0:0,F=Math.max(30,Math.round((C.value||.5)*60/30)*30),D=Math.min(P+F,1439);h=!0,f.setValue(this.minutesToHhmm(D),{emitEvent:!1}),this.enforceCapForSession(i,e.controls.indexOf(p)),b(),h=!1};this.subscriptions.push(g.valueChanges.subscribe(()=>_())),this.subscriptions.push(f.valueChanges.subscribe(()=>{h||(b(),this.enforceCapForSession(i,e.controls.indexOf(p)),b())})),this.subscriptions.push(C.valueChanges.subscribe(()=>_())),e.push(p)}removeSesion(i,e){this.sesiones(i).removeAt(e)}validateEvalRules(){let i=this.procesosFA.controls.findIndex(e=>e.get("tipo_registro").value==="EVALUACION");if(i>=0){if(this.procesosFA.length>1)return"Para procesos de EVALUACI\xD3N s\xF3lo se permite 1 proceso en el proyecto.";if(this.sesiones(i).length!==1)return"El proceso de EVALUACI\xD3N debe tener exactamente 1 sesi\xF3n.";let t=Number(this.form.get("horas_planificadas").value||0);if(Number(this.procesosFA.at(i).get("horas_asignadas").value||0)!==t)return"En EVALUACI\xD3N las horas asignadas se igualan a las horas planificadas del proyecto.";let l=Number(this.procesosFA.at(i).get("nota_minima").value||0);if(!(l>=Z&&l<=ee))return`La nota m\xEDnima en EVALUACI\xD3N debe estar entre ${Z} y ${ee}.`}return null}validateProcesosCapPorHoras(){for(let i=0;i<this.procesosFA.length;i++){if(!this.isHoursDriven(i))continue;let e=this.getHorasAsignadas(i)*60,t=this.usedMinutesProceso(i);if(t>e)return`En "${this.procesosFA.at(i).get("nombre").value}": las horas de las sesiones (${(t/60).toFixed(2)} h) exceden las asignadas (${this.getHorasAsignadas(i)} h).`;if(t===0)return`En "${this.procesosFA.at(i).get("nombre").value}": agrega al menos una sesi\xF3n con rango horario v\xE1lido.`}return null}validateSessionTimeRanges(){for(let i=0;i<this.procesosFA.length;i++){let e=this.sesiones(i);for(let t=0;t<e.length;t++){let n=e.at(t),l=this.sanitizeHora(String(n.get("hora_inicio").value||"")),c=this.sanitizeHora(String(n.get("hora_fin").value||""));if(!l||!c)continue;let p=this.hhmmToMinutes(l),g=this.hhmmToMinutes(c);if(p==null||g==null||g<=p)return{path:["procesos",i,"sesiones",t,"hora_fin"],message:"La hora fin debe ser mayor que la hora inicio y no puede cruzar medianoche."}}}return null}validateFechasDentroPeriodo(){let i=this.form.get("periodo_id").value,e=this.periodosIndex[i]||{};if(!e.inicio||!e.fin)return null;for(let t=0;t<this.procesosFA.length;t++){let n=this.sesiones(t);for(let l=0;l<n.length;l++){let c=this.sanitizeFecha(String(n.at(l).get("fecha").value||""));if(c&&!(e.inicio<=c&&c<=e.fin))return{path:["procesos",t,"sesiones",l,"fecha"],message:`La fecha debe estar entre ${e.inicio} y ${e.fin}.`}}}return null}validatePerNivelIgualPlan(){if(this.tipo()!=="VINCULADO")return null;let i=this.nivelesCtrl.value??[];if(!i.length)return null;let e=this.planMin(),t=this.usedMinutesByNivel(),n=[];for(let l of i){let c=t[l]||0;c!==e&&(c<e?n.push(`Ciclo ${l}: faltan ${((e-c)/60).toFixed(2)} h para alcanzar ${e/60} h.`):n.push(`Ciclo ${l}: excede por ${((c-e)/60).toFixed(2)} h el objetivo de ${e/60} h.`))}return n.length?n:null}validateAsignadasVsPlan(){if(this.hasEvaluationProcess())return null;let i=this.totalAsignadas(),e=Number(this.form.get("horas_planificadas").value||0),t=this.tipo()==="VINCULADO"&&this.nivelesCtrl.value?.length||0,n=this.allowedPlanTotal();return t>=2&&this.tipo()==="VINCULADO"?i>n+1e-6?`Las horas asignadas (${i} h) exceden el tope global (${n} h = ${e} h \xD7 ${t} ciclo(s)). Reduce o redistribuye.`:null:Math.abs(i-e)>1e-6?`La suma de horas asignadas (${i} h) debe ser igual a las horas planificadas del proyecto (${e} h).`:null}buildBatchPayloads(i){let e=this.sesiones(i),t=new Map,n=this.tipo()==="VINCULADO",l=(c,p,g)=>`${c}-${p}-[${[...g].sort((f,C)=>f-C).join(",")}]`;for(let c of e.controls){let p=c.get("fecha").value,g=c.get("hora_inicio").value,f=c.get("hora_fin").value,C=c.get("niveles").value||[],h=this.sanitizeFecha(p),b=this.sanitizeHora(g),_=this.sanitizeHora(f);if(!h||!b||!_)continue;let x=l(b,_,n?C:[]);t.has(x)||t.set(x,{hora_inicio:b,hora_fin:_,fechas:[],niveles:n&&C.length?[...C]:void 0}),t.get(x).fechas.push(h)}return Array.from(t.values()).map(c=>G({mode:"list"},c))}async onSubmit(){try{this.serverErr.set(null),this.clearServerErrors(),this.nivelesBloqueadosSrv.set([]),this.form.markAllAsTouched();let i=this.validateEvalRules();if(i){this.serverErr.set(i);return}let e=this.validateSessionTimeRanges();if(e){this.serverErr.set("Corrige los errores de horario."),this.serverFieldErrors.set({[this.pathKey(e.path)]:[e.message]});return}let t=this.validateFechasDentroPeriodo();if(t){this.serverErr.set("Hay fechas fuera del per\xEDodo del proyecto."),this.serverFieldErrors.set({[this.pathKey(t.path)]:[t.message]});return}let n=this.validateProcesosCapPorHoras();if(n){this.serverErr.set(n);return}let l=this.validatePerNivelIgualPlan();if(l?.length){this.serverErr.set(l.join(" \xB7 "));return}let c=this.validateAsignadasVsPlan();if(c){this.serverErr.set(c);return}this.submitting.set(!0);let p=Number(this.form.get("horas_planificadas").value||0),g={ep_sede_id:this.form.get("ep_sede_id").value,periodo_id:this.form.get("periodo_id").value,codigo:this.form.get("codigo").value||null,titulo:this.form.get("titulo").value,descripcion:this.form.get("descripcion").value||null,tipo:this.form.get("tipo").value,modalidad:this.form.get("modalidad").value,horas_planificadas:p,horas_minimas_participante:null};this.tipo()==="VINCULADO"&&(g.niveles=this.nivelesCtrl.value??[]);let f=await T(this.api.crearProyecto(g));if(!Te(f))throw new Error("Error creando proyecto");let C=f.data.id;this.createdProyectoId=C;for(let h=0;h<this.procesosFA.length;h++){let b=this.procesosFA.at(h),_=b.get("tipo_registro").value,x={nombre:b.get("nombre").value,descripcion:b.get("descripcion").value||null,tipo_registro:_,requiere_asistencia:!!b.get("requiere_asistencia").value,orden:h+1},P=b.get("horas_asignadas");P.enabled&&(_==="HORAS"||_==="MIXTO")&&(x.horas_asignadas=Number(P.value||0));let F=b.get("nota_minima");F.enabled&&(_==="EVALUACION"||_==="MIXTO")&&(x.nota_minima=Number(F.value||0));let D=await T(this.api.crearProceso(C,x));if(!Te(D))throw new Error("Error creando proceso");let W=D.data.id,j=this.buildBatchPayloads(h);for(let O of j){let te=/^\d{2}:\d{2}$/.test(O.hora_inicio)&&/^\d{2}:\d{2}$/.test(O.hora_fin),Ye=O.fechas&&O.fechas.length>0&&O.fechas.every(Je=>/^\d{4}-\d{2}-\d{2}$/.test(Je));if(!te){this.serverErr.set("Formato de hora inv\xE1lido. Usa HH:mm."),this.submitting.set(!1);return}if(!Ye){this.serverErr.set("Una o m\xE1s fechas tienen formato inv\xE1lido. Usa AAAA-MM-DD."),this.submitting.set(!1);return}}for(let O of j)await T(this.api.crearSesionesBatch(W,O))}for(let h of this.imagenes())try{await T(this.api.subirImagenProyecto(C,h.file))}catch{}this.createdProyectoId=null,this.router.navigate(["/vm/proyectos",C])}catch(i){console.error(i);let e="Error del servidor. Por favor, intenta m\xE1s tarde.";if(i?.status===422){let t=this.extractServerValidation(i);e=t.message||"Datos inv\xE1lidos. Revisa los campos.",this.serverFieldErrors.set(t.fields);let n=[t.message,...t.fields.niveles||[]].filter(Boolean),l=new Set;if(n.forEach(c=>this.parseCiclosFromText(c).forEach(p=>l.add(p))),l.size){this.nivelesBloqueadosSrv.set([...l]);let c=this.form.get("ep_sede_id").value,p=this.form.get("periodo_id").value;try{await this.loadNivelesDisponibles(c,p)}catch{}this.step.set(1)}}else if(i?.status===403)e="No tienes permisos para esta operaci\xF3n.";else if(i?.status===401)e="Tu sesi\xF3n ha expirado. Inicia sesi\xF3n nuevamente.";else if(i?.status===500){let t=String(i?.error?.message||i?.message||"");/InvalidFormat|Double time specification|Carbon/i.test(t)?e="Formato de fecha/hora inv\xE1lido en el servidor. Verifica usar fecha AAAA-MM-DD y hora HH:mm.":e="Error interno del servidor. Verifica horas/fechas."}else i?.message?.includes("Network")&&(e="Error de conexi\xF3n. Verifica tu internet.");if(this.createdProyectoId)try{await T(this.api.eliminarProyecto(this.createdProyectoId)),e+=" Se anul\xF3 el proyecto parcial."}catch{e+=" No se pudo anular autom\xE1ticamente el proyecto parcial."}finally{this.createdProyectoId=null}this.serverErr.set(e)}finally{this.submitting.set(!1)}}openCancel(){this.showCancel.set(!0)}closeCancel(){this.showCancel.set(!1)}async confirmCancel(){if(this.showCancel.set(!1),!this.createdProyectoId){this.router.navigate(["/vm/proyectos"]);return}try{this.rollingBack.set(!0),await T(this.api.eliminarProyecto(this.createdProyectoId))}catch(i){console.error("Error al anular proyecto parcial",i)}finally{this.rollingBack.set(!1),this.router.navigate(["/vm/proyectos"])}}async loadLookups(){try{let[i,e]=await Promise.all([T(this.lookups.fetchMyEpSedesStaff(50)),T(this.lookups.fetchPeriodos("",!1,50))]);e.forEach(n=>{this.periodosIndex[n.id]={inicio:n.fecha_inicio||void 0,fin:n.fecha_fin||void 0,codigo:n.codigo||`${n.anio} - ${n.ciclo}`}}),this.epOptions.set(i.map(n=>({value:n.id,label:n.label}))),this.perOptions.set(e.map(n=>({value:n.id,label:`${n.anio??""} - ${n.ciclo??""}`.trim().replace(/^ - | - $/g,"")||(n.codigo??n.id),estado:n.estado}))),!this.form.get("ep_sede_id").value&&i.length&&this.form.get("ep_sede_id").setValue(i[0].id);let t=e.find(n=>String(n.estado||"").toUpperCase()==="EN_CURSO")??e.find(n=>String(n.estado||"").toUpperCase()==="PLANIFICADO")??e[0];t&&!this.form.get("periodo_id").value&&this.form.get("periodo_id").setValue(t.id),this.form.get("tipo").value==="VINCULADO"&&this.form.get("ep_sede_id").value&&this.form.get("periodo_id").value&&await this.loadNivelesDisponibles(this.form.get("ep_sede_id").value,this.form.get("periodo_id").value)}catch{this.serverErr.set("No se pudieron cargar las opciones. Verifica tu conexi\xF3n a internet.")}}async loadNivelesDisponibles(i,e){try{this.nivelesLoadWarning.set(null),this.nivelesBloqueadosSrv.set([]);let t=await T(this.api.nivelesDisponibles({ep_sede_id:i,periodo_id:e})),l=(Array.isArray(t.data)?t.data:t).filter(f=>typeof f=="number"&&f>=1&&f<=10),c=new Set(this.nivelesCtrl.value??[]),p=new Set(l),g=[...c].filter(f=>p.has(f));this.nivelesDisponibles.set(l),this.nivelesCtrl.setValue(g)}catch{this.nivelesDisponibles.set([]),this.nivelesCtrl.setValue([]),this.nivelesLoadWarning.set("No se pudo obtener la disponibilidad de ciclos para la sede/per\xEDodo seleccionados.")}}};R.\u0275fac=function(e){return new(e||R)},R.\u0275cmp=ne({type:R,selectors:[["app-proyecto-wizard-page"]],decls:126,vars:76,consts:[["noNiveles",""],[1,"min-h-screen","bg-gradient-to-b","from-gray-50","to-white","pb-12"],[1,"h-1","w-full","bg-gray-200"],[1,"h-1","bg-blue-600","transition-all","duration-500","ease-out"],[1,"max-w-7xl","mx-auto","px-4","sm:px-6","lg:px-8","pt-6"],[1,"relative","overflow-hidden","rounded-2xl","border","border-gray-200","bg-white/70","backdrop-blur","shadow-sm"],[1,"absolute","inset-0","bg-gradient-to-r","from-blue-50","via-transparent","to-purple-50","opacity-70","pointer-events-none"],[1,"relative","p-6","md:p-8"],[1,"flex","items-start","justify-between"],[1,"text-3xl","font-extrabold","tracking-tight","text-gray-900"],[1,"mt-2","text-gray-600"],["type","button","aria-label","Cancelar y salir",1,"group","inline-flex","items-center","justify-center","rounded-full","border","border-gray-200","bg-white/90","p-2","shadow-sm","transition","hover:shadow-md","hover:scale-105","hover:bg-white",3,"click","disabled"],["fill","none","viewBox","0 0 24 24","stroke","currentColor",1,"h-5","w-5","text-gray-500","group-hover:text-red-600","transition"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M6 18L18 6M6 6l12 12"],[1,"mt-6","flex","items-center","gap-3"],[1,"px-4","py-1.5","rounded-full","text-sm","font-medium","transition"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-4","h-4","text-gray-400"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M9 5l7 7-7 7"],["class","mt-6",4,"ngIf"],[1,"mt-8",3,"ngSubmit","formGroup"],[1,"relative"],[1,"grid","md:grid-cols-2","gap-6"],[1,"bg-white","border","border-gray-200","rounded-2xl","p-6","shadow-sm"],[1,"text-lg","font-semibold","text-gray-900","mb-4"],[1,"grid","grid-cols-1","gap-4"],[1,"block","text-sm","font-medium","mb-1"],["formControlName","ep_sede_id",1,"w-full","border","rounded-lg","px-3","py-2"],[3,"ngValue"],[3,"ngValue",4,"ngFor","ngForOf"],["class","text-xs text-red-600 mt-1",4,"ngIf"],["formControlName","periodo_id",1,"w-full","border","rounded-lg","px-3","py-2"],["formControlName","titulo","placeholder","T\xEDtulo del proyecto",1,"w-full","border","rounded-lg","px-3","py-2"],["rows","3","formControlName","descripcion",1,"w-full","border","rounded-lg","px-3","py-2"],[1,"grid","grid-cols-1","md:grid-cols-3","gap-4"],["formControlName","tipo",1,"w-full","border","rounded-lg","px-3","py-2"],["value","VINCULADO"],["value","LIBRE"],["formControlName","modalidad",1,"w-full","border","rounded-lg","px-3","py-2"],["value","PRESENCIAL"],["value","VIRTUAL"],["value","MIXTA"],["type","number","formControlName","horas_planificadas","min","1","step","1",1,"w-full","border","rounded-lg","px-3","py-2"],[4,"ngIf"],["type","file","multiple","","accept","image/*",1,"block","w-full","text-sm","text-gray-600","file:mr-4","file:py-2","file:px-3","file:rounded-lg","file:border-0","file:bg-blue-600","file:text-white","file:cursor-pointer","hover:file:bg-blue-700",3,"change"],["class","grid grid-cols-2 md:grid-cols-3 gap-3 mt-4",4,"ngIf"],[1,"text-xs","text-gray-500","mt-3"],[1,"flex","justify-end","gap-3","mt-6"],["type","button",1,"px-5","py-2.5","rounded-xl","bg-blue-600","text-white","hover:bg-blue-700",3,"click","disabled"],[1,"flex","items-center","justify-between","mb-3"],[1,"text-lg","font-semibold","text-gray-900"],[1,"text-sm",3,"ngClass"],["class","mb-5 space-y-2",4,"ngIf"],["class","mb-4 p-3 rounded-lg bg-amber-50 border border-amber-200 text-amber-800 text-sm",4,"ngIf"],["formArrayName","procesos",1,"space-y-6"],["class","rounded-xl border p-4",3,"formGroupName",4,"ngFor","ngForOf"],[1,"mt-6"],["type","button",1,"px-4","py-2","rounded-lg","text-white",3,"click","disabled"],[1,"flex","justify-between","items-center","gap-3","mt-6"],["type","button",1,"px-4","py-2","rounded-lg","border",3,"click"],["type","submit",1,"px-5","py-2.5","rounded-xl","bg-blue-600","text-white","hover:bg-blue-700","disabled:opacity-60",3,"disabled"],["class","fixed inset-0 z-50 flex items-center justify-center",4,"ngIf"],["role","alert","aria-live","assertive",1,"flex","items-center","rounded-lg","border","border-red-200","bg-red-50","p-3","text-red-700"],["fill","currentColor","viewBox","0 0 20 20","aria-hidden","true",1,"w-5","h-5","mr-2"],["fill-rule","evenodd","d","M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z","clip-rule","evenodd"],[1,"text-xs","text-red-600","mt-1"],[1,"block","text-sm","font-medium","mb-2"],["class","mb-2 rounded-md border border-amber-200 bg-amber-50 text-amber-800 text-xs px-3 py-2",4,"ngIf"],["class","flex flex-wrap gap-2",4,"ngIf","ngIfElse"],["class","mt-2 text-xs text-red-600",4,"ngIf"],[1,"flex","gap-2","mt-2"],["type","button",1,"text-xs","px-2","py-1","rounded","border",3,"click","disabled"],["type","button",1,"text-xs","px-2","py-1","rounded","border",3,"click"],[1,"mb-2","rounded-md","border","border-amber-200","bg-amber-50","text-amber-800","text-xs","px-3","py-2"],[1,"flex","flex-wrap","gap-2"],["class","inline-flex items-center gap-2 px-3 py-1.5 rounded-full border border-gray-300 bg-white text-gray-700 cursor-pointer hover:bg-blue-50",4,"ngFor","ngForOf"],[1,"inline-flex","items-center","gap-2","px-3","py-1.5","rounded-full","border","border-gray-300","bg-white","text-gray-700","cursor-pointer","hover:bg-blue-50"],["type","checkbox",1,"rounded","border-gray-300",3,"change","checked"],[1,"text-sm"],[1,"text-xs","text-amber-700"],[1,"mt-2","text-xs","text-red-600"],[4,"ngFor","ngForOf"],[1,"grid","grid-cols-2","md:grid-cols-3","gap-3","mt-4"],["class","relative group",4,"ngFor","ngForOf"],[1,"relative","group"],["alt","preview",1,"w-full","h-32","object-cover","rounded-lg","border",3,"src"],["type","button",1,"absolute","top-2","right-2","bg-white/90","text-red-600","border","border-red-200","rounded-full","px-2","py-0.5","text-xs","shadow-sm","opacity-0","group-hover:opacity-100","transition",3,"click"],[1,"mb-5","space-y-2"],[1,"text-xs","text-gray-500"],[1,"grid","md:grid-cols-2","lg:grid-cols-3","gap-3"],["class","rounded-lg border p-3",4,"ngFor","ngForOf"],[1,"rounded-lg","border","p-3"],[1,"flex","items-center","justify-between"],[1,"text-sm","font-medium"],[1,"mt-2","h-2","w-full","bg-gray-200","rounded-full","overflow-hidden"],[1,"h-2",3,"ngClass"],[1,"mt-1","text-xs",3,"ngClass"],[1,"mb-4","p-3","rounded-lg","bg-amber-50","border","border-amber-200","text-amber-800","text-sm"],[1,"rounded-xl","border","p-4",3,"formGroupName"],[1,"grid","md:grid-cols-4","gap-3"],["formControlName","nombre","placeholder","Nombre del proceso",1,"border","rounded-lg","px-3","py-2","w-full"],["formControlName","tipo_registro",1,"border","rounded-lg","px-3","py-2","w-full"],["value","HORAS"],["value","ASISTENCIA"],["value","EVALUACION"],["value","MIXTO"],[1,"flex","items-center"],[1,"inline-flex","items-center","gap-2","text-sm"],["type","checkbox","formControlName","requiere_asistencia"],["class","text-xs text-gray-500 ml-2",4,"ngIf"],["class","mt-1 text-xs",3,"ngClass",4,"ngIf"],["rows","2","formControlName","descripcion","placeholder","Descripci\xF3n (opcional)",1,"w-full","mt-3","border","rounded-lg","px-3","py-2"],["formArrayName","sesiones",1,"mt-4","rounded-lg","border","p-3"],[1,"font-semibold","text-gray-800"],["type","button",1,"text-sm","px-3","py-1.5","rounded-lg","text-white",3,"click","disabled"],[1,"mt-3","grid","gap-3"],["class","grid md:grid-cols-7 gap-3 items-end",3,"formGroupName",4,"ngFor","ngForOf"],[1,"mt-2","text-xs","text-gray-500"],[1,"mt-3","flex","justify-end"],["type","button",1,"px-3","py-1.5","rounded-lg","border","text-red-600","border-red-200","hover:bg-red-50",3,"click"],["type","number","min","1","step","1","formControlName","horas_asignadas","placeholder","Horas asignadas",1,"border","rounded-lg","px-3","py-2","w-full"],[1,"text-xs","text-gray-500","ml-2"],["type","number","min","1","max","20","step","1","formControlName","nota_minima","placeholder","Nota m\xEDnima (1\u201320)",1,"border","rounded-lg","px-3","py-2","w-full"],[1,"grid","md:grid-cols-7","gap-3","items-end",3,"formGroupName"],[1,"text-xs","block","mb-1"],["type","date","formControlName","fecha",1,"border","rounded-lg","px-3","py-2","w-full"],["type","time","formControlName","hora_inicio","step","60",1,"border","rounded-lg","px-3","py-2","w-full"],["type","time","formControlName","hora_fin","step","60",1,"border","rounded-lg","px-3","py-2","w-full"],["type","number","min","0.5","step","0.5","formControlName","duracion_horas",1,"border","rounded-lg","px-3","py-2","w-full"],["class","md:col-span-2",4,"ngIf"],["type","button",1,"px-3","py-2","rounded-lg","border","text-red-600","border-red-200","hover:bg-red-50","w-full",3,"click"],[1,"md:col-span-2"],[1,"text-xs","text-gray-600","mb-1"],["class","inline-flex items-center gap-2 px-2 py-1 rounded-md border cursor-pointer transition",3,"ngClass",4,"ngFor","ngForOf"],[1,"mt-1","text-[11px]","text-gray-500"],[1,"inline-flex","items-center","gap-2","px-2","py-1","rounded-md","border","cursor-pointer","transition",3,"ngClass"],["type","checkbox",1,"rounded","border-gray-300",3,"change","checked","disabled"],[1,"text-xs"],[1,"mr-2"],[1,"fixed","inset-0","z-50","flex","items-center","justify-center"],[1,"absolute","inset-0","bg-black/40","backdrop-blur-sm",3,"click"],[1,"relative","w-full","max-w-md","mx-auto","rounded-2xl","bg-white","shadow-2xl","border","border-gray-200","p-6"],[1,"mt-2","text-sm","text-gray-600"],[1,"font-medium"],[1,"mt-6","flex","justify-end","gap-3"],["type","button",1,"px-4","py-2","rounded-lg","bg-red-600","text-white",3,"click","disabled"]],template:function(e,t){e&1&&(s(0,"div",1)(1,"div",2),S(2,"div",3),o(),s(3,"div",4)(4,"div",5),S(5,"div",6),s(6,"div",7)(7,"div",8)(8,"div")(9,"h1",9),a(10,"Nuevo Proyecto"),o(),s(11,"p",10),a(12,"Crea un proyecto acad\xE9mico con sus procesos y sesiones."),o()(),s(13,"button",11),I("click",function(){return t.openCancel()}),q(),s(14,"svg",12),S(15,"path",13),o()()(),X(),s(16,"div",14)(17,"div",15),a(18," Paso 1: Informaci\xF3n "),o(),q(),s(19,"svg",16),S(20,"path",17),o(),X(),s(21,"div",15),a(22," Paso 2: Procesos "),o()()()(),v(23,it,5,1,"div",18),s(24,"form",19),I("ngSubmit",function(){return t.onSubmit()}),s(25,"div",20)(26,"div")(27,"div",21)(28,"div",22)(29,"h3",23),a(30,"Datos del proyecto"),o(),s(31,"div",24)(32,"div")(33,"label",25),a(34,"EP_SEDE"),o(),s(35,"select",26)(36,"option",27),a(37,"Seleccione\u2026"),o(),v(38,nt,2,2,"option",28),o(),v(39,rt,2,2,"p",29),o(),s(40,"div")(41,"label",25),a(42,"Per\xEDodo"),o(),s(43,"select",30)(44,"option",27),a(45,"Seleccione\u2026"),o(),v(46,ot,2,2,"option",28),o(),v(47,st,2,2,"p",29),o(),s(48,"div")(49,"label",25),a(50,"T\xEDtulo"),o(),S(51,"input",31),v(52,at,2,2,"p",29),o(),s(53,"div")(54,"label",25),a(55,"Descripci\xF3n"),o(),S(56,"textarea",32),v(57,lt,2,2,"p",29),o(),s(58,"div",33)(59,"div")(60,"label",25),a(61,"Tipo"),o(),s(62,"select",34)(63,"option",35),a(64,"VINCULADO"),o(),s(65,"option",36),a(66,"LIBRE"),o()(),v(67,dt,2,2,"p",29),o(),s(68,"div")(69,"label",25),a(70,"Modalidad"),o(),s(71,"select",37)(72,"option",38),a(73,"PRESENCIAL"),o(),s(74,"option",39),a(75,"VIRTUAL"),o(),s(76,"option",40),a(77,"MIXTA"),o()(),v(78,ct,2,2,"p",29),o(),s(79,"div")(80,"label",25),a(81,"Horas planificadas"),o(),S(82,"input",41),v(83,ut,2,2,"p",29),o()(),v(84,xt,14,7,"div",42),o()(),s(85,"div",22)(86,"h3",23),a(87,"Im\xE1genes"),o(),s(88,"input",43),I("change",function(l){return t.onFilesSelected(l)}),o(),v(89,Ct,2,1,"div",44),s(90,"p",45),a(91,"M\xE1x. 5MB por imagen."),o()()(),s(92,"div",46)(93,"button",47),I("click",function(){return t.goNext()}),a(94," Continuar "),o()()(),s(95,"div")(96,"div",22)(97,"div",48)(98,"h3",49),a(99,"Procesos"),o(),s(100,"div",50),a(101),s(102,"b"),a(103),o(),a(104,"/"),s(105,"b"),a(106),o(),a(107," h "),v(108,Et,5,2,"ng-container",42),a(109," \xB7 Restan: "),s(110,"b"),a(111),o(),a(112," h "),o()(),v(113,Pt,5,1,"div",51)(114,At,5,0,"div",52),s(115,"div",53),v(116,$t,38,19,"div",54),o(),s(117,"div",55)(118,"button",56),I("click",function(){return t.addProceso()}),a(119," Agregar proceso "),o()()(),s(120,"div",57)(121,"button",58),I("click",function(){return t.step.set(1)}),a(122,"Volver"),o(),s(123,"button",59),a(124),o()()()()()(),v(125,Bt,15,2,"div",60),o()),e&2&&(d(2),K("width",t.step()===1?50:100,"%"),d(11),m("disabled",t.submitting()||t.rollingBack()),d(4),H("bg-blue-100",t.step()===1)("text-blue-800",t.step()===1)("border",t.step()===1)("border-blue-300",t.step()===1)("bg-gray-100",t.step()!==1)("text-gray-600",t.step()!==1),d(4),H("bg-blue-100",t.step()===2)("text-blue-800",t.step()===2)("border",t.step()===2)("border-blue-300",t.step()===2)("bg-gray-100",t.step()!==2)("text-gray-600",t.step()!==2),d(2),m("ngIf",t.serverErr()),d(),m("formGroup",t.form),d(2),H("hidden",t.step()!==1),d(10),m("ngValue",null),d(2),m("ngForOf",t.epOptions()),d(),m("ngIf",t.hasError("ep_sede_id")||t.getSvr(A(66,Oe))),d(5),m("ngValue",null),d(2),m("ngForOf",t.perOptions()),d(),m("ngIf",t.hasError("periodo_id")||t.getSvr(A(67,ke))),d(5),m("ngIf",t.hasError("titulo")||t.getSvr(A(68,ze))),d(5),m("ngIf",t.getSvr(A(69,Le))),d(10),m("ngIf",t.getSvr(A(70,He))),d(11),m("ngIf",t.getSvr(A(71,We))),d(5),m("ngIf",t.hasError("horas_planificadas")||t.getSvr(A(72,Re))),d(),m("ngIf",t.tipo()==="VINCULADO"),d(5),m("ngIf",t.imagenes().length),d(4),m("disabled",t.submitting()||t.rollingBack()),d(2),H("hidden",t.step()!==2),d(5),m("ngClass",z(73,Ze,t.totalAsignadas()>t.allowedPlanTotal(),t.totalAsignadas()<=t.allowedPlanTotal())),d(),E(" ",t.procesos().length," proceso(s) \xB7 Asignadas (HORAS/MIXTO): "),d(2),w(t.totalAsignadas()),d(3),w(t.allowedPlanTotal()),d(2),m("ngIf",t.tipo()==="VINCULADO"&&((t.nivelesCtrl.value==null?null:t.nivelesCtrl.value.length)||0)>=2),d(3),w(t.remainingProject()),d(2),m("ngIf",t.tipo()==="VINCULADO"&&((t.nivelesCtrl.value==null?null:t.nivelesCtrl.value.length)||0)>=1),d(),m("ngIf",t.hasEvaluationProcess()),d(2),m("ngForOf",t.procesos()),d(2),H("bg-emerald-600",t.canAddProceso())("bg-gray-300",!t.canAddProceso())("cursor-not-allowed",!t.canAddProceso()),m("disabled",!t.canAddProceso()),d(5),m("disabled",t.submitting()||t.rollingBack()),d(),E(" ",t.submitting()?"Creando\u2026":"Crear proyecto"," "),d(),m("ngIf",t.showCancel()))},dependencies:[me,le,de,ce,we,_e,Pe,Ae,ve,be,ge,Se,he,fe,Fe,Ie,xe,Ee,ye,Ce,ue],encapsulation:2});var De=R;export{De as ProyectoWizardPage};
