import{a as y}from"./chunk-VU2HTVBD.js";import{A as q,B as G,b as $,d as z,h as H,m as J}from"./chunk-J2XPQYKK.js";import{a as K}from"./chunk-QG2H74YZ.js";import"./chunk-LWNR2F3M.js";import{d as O,j as L}from"./chunk-5VQTM22E.js";import{j as D,k as V,l as F,m as R,n as M,q as B,u as j}from"./chunk-FE5WSVYG.js";import{$a as n,Ka as C,Kb as w,Mb as P,Ob as I,Pa as _,T as k,Y as p,Z as u,_a as c,ab as i,eb as v,fa as x,fb as b,gb as T,kb as g,mb as h,n as f,rb as A,vb as a,wb as m,xb as S,ya as o,yb as N}from"./chunk-63T4HJ2B.js";import"./chunk-IMPBB4AK.js";function W(r,t){if(r&1&&(v(0),n(1,"span",24),a(2),w(3,"date"),i(),b()),r&2){let e=t.ngIf;o(2),S("\u2022 \xDAlt. act: ",P(3,1,e,"shortTime"))}}function X(r,t){if(r&1&&(v(0),n(1,"div",25),a(2),i(),b()),r&2){let e=h();o(2),S(" ",e.error()," ")}}function Y(r,t){if(r&1&&(v(0),a(1," Vence en "),n(2,"b"),a(3),i(),a(4," min "),b()),r&2){let e=h();o(3),m(e.minutosRestantes())}}function Z(r,t){if(r&1&&(n(0,"tr",33)(1,"td",34),a(2),w(3,"date"),i(),n(4,"td",34),a(5),i(),n(6,"td",34),a(7),i(),n(8,"td",34),a(9),i(),n(10,"td",34),a(11),i(),n(12,"td",34),a(13),i(),n(14,"td",34),a(15),i()()),r&2){let e=t.$implicit;o(2),S(" ",P(3,7,e.check_in_at,"shortTime")," "),o(3),m(e.codigo||"\u2014"),o(2),m(e.dni||"\u2014"),o(2),m(e.nombres||"\u2014"),o(2),m(e.apellidos||"\u2014"),o(2),m(e.metodo),o(2),m(e.estado)}}function ee(r,t){if(r&1&&(n(0,"div")(1,"div",26)(2,"table",27)(3,"thead",12)(4,"tr")(5,"th",28),a(6,"Hora"),i(),n(7,"th",29),a(8,"C\xF3digo"),i(),n(9,"th",29),a(10,"DNI"),i(),n(11,"th",30),a(12,"Nombres"),i(),n(13,"th",30),a(14,"Apellidos"),i(),n(15,"th",31),a(16,"M\xE9todo"),i(),n(17,"th",29),a(18,"Estado"),i()()(),n(19,"tbody"),_(20,Z,16,10,"tr",32),i()()()()),r&2){let e=h();o(20),c("ngForOf",e.asistencias())("ngForTrackBy",e.trackByAsistencia)}}function te(r,t){r&1&&(n(0,"div",12),a(1,"A\xFAn sin registros."),i())}function ie(r,t){r&1&&(n(0,"span",43),a(1,"PRESENTE"),i())}function ne(r,t){r&1&&(n(0,"span",44),a(1,"FALTA"),i())}function ae(r,t){r&1&&(n(0,"span",45),a(1,"\u2014"),i())}function re(r,t){if(r&1&&(v(0),a(1),w(2,"date"),b()),r&2){let e=t.ngIf;o(),N(" ",e.metodo," \u2022 ",P(2,2,e.check_in_at,"shortTime")," ")}}function se(r,t){r&1&&a(0,"\u2014")}function oe(r,t){if(r&1){let e=T();n(0,"tr",33)(1,"td",34),a(2),i(),n(3,"td",34),a(4),i(),n(5,"td",34),a(6),i(),n(7,"td",34),a(8),i(),n(9,"td",34),v(10,37),_(11,ie,2,0,"span",38)(12,ne,2,0,"span",39)(13,ae,2,0,"span",40),b(),i(),n(14,"td",34),_(15,re,3,5,"ng-container",22)(16,se,1,0,"ng-template",null,2,I),i(),n(18,"td",34)(19,"div",16)(20,"button",41),g("click",function(){let l=p(e).$implicit,d=h(2);return u(d.doRegisterFromRow(l))}),a(21," Registrar "),i(),n(22,"button",42),g("click",function(){let l=p(e).$implicit,d=h(2);return u(d.justificarFueraDeHora(l))}),a(23," Justificar fuera de hora "),i()()()()}if(r&2){let e=t.$implicit,s=A(17);o(2),m(e.codigo||"\u2014"),o(2),m(e.dni||"\u2014"),o(2),m(e.nombres||"\u2014"),o(2),m(e.apellidos||"\u2014"),o(2),c("ngSwitch",e.estado_calculado),o(),c("ngSwitchCase","PRESENTE"),o(),c("ngSwitchCase","FALTA"),o(3),c("ngIf",e.asistencia)("ngIfElse",s),o(5),c("disabled",!e.codigo||e.estado_calculado==="PRESENTE"),o(2),c("disabled",!e.codigo||e.estado_calculado!=="FALTA")}}function le(r,t){if(r&1&&(n(0,"div")(1,"div",26)(2,"table",27)(3,"thead",12)(4,"tr")(5,"th",29),a(6,"C\xF3digo"),i(),n(7,"th",29),a(8,"DNI"),i(),n(9,"th",30),a(10,"Nombres"),i(),n(11,"th",30),a(12,"Apellidos"),i(),n(13,"th",29),a(14,"Estado"),i(),n(15,"th",35),a(16,"Asistencia"),i(),n(17,"th",36),a(18,"Acciones"),i()()(),n(19,"tbody"),_(20,oe,24,11,"tr",32),i()()()()),r&2){let e=h();o(20),c("ngForOf",e.participantes())("ngForTrackBy",e.trackByParticipante)}}function ce(r,t){r&1&&(n(0,"div",12),a(1,"No hay participantes inscritos/confirmados."),i())}var E=class E{constructor(){this.api=k(K);this.route=k(O);this.sesionId=x(0);this.loading=x(!0);this.error=x(null);this.ventana=x(null);this.asistencias=x([]);this.participantes=x([]);this.now=x(new Date);this.lastSync=x(null);this.codigo=new H("",{nonNullable:!0});this.trackByAsistencia=(t,e)=>e.id;this.trackByParticipante=(t,e)=>e.participacion_id;let t=Number(this.route.snapshot.paramMap.get("sesionId"));this.sesionId.set(t),this.bootstrap(),this.pollTimer=setInterval(()=>this.refreshAsistencias(),5e3),this.clock=setInterval(()=>this.now.set(new Date),3e4)}ngOnDestroy(){this.pollTimer&&clearInterval(this.pollTimer),this.clock&&clearInterval(this.clock)}async bootstrap(){this.loading.set(!0);try{await this.activarManual(),await this.refreshAsistencias(!0),await this.loadParticipantes()}catch(t){this.error.set(t?.error?.message||"No se pudo inicializar la p\xE1gina de asistencia.")}finally{this.loading.set(!1)}}async activarManual(){this.error.set(null);try{let t=await f(this.api.activarVentanaManual(this.sesionId()));if(!t||!y(t))throw new Error(t?.message||"Fallo al activar el llamado manual.");this.ventana.set(t.data)}catch(t){this.error.set(t?.error?.message||"No se pudo activar la ventana manual.")}}async doCheckIn(){let t=(this.codigo.value||"").trim();if(t)try{let e=await f(this.api.checkInManualPorCodigo(this.sesionId(),t));e&&y(e)?(this.codigo.setValue(""),await this.refreshAsistencias(!0),await this.loadParticipantes()):alert(e?.message||"No se pudo registrar.")}catch(e){alert(e?.error?.message||"Error al registrar.")}}async doRegisterFromRow(t){if(t?.codigo)try{let e=await f(this.api.checkInManualPorCodigo(this.sesionId(),t.codigo));e&&y(e)?(await this.refreshAsistencias(!0),await this.loadParticipantes()):alert(e?.message||"No se pudo registrar.")}catch(e){alert(e?.error?.message||"Error al registrar.")}}async justificarFueraDeHora(t){if(!t?.codigo)return;let e=prompt(`Justificaci\xF3n para ${t.nombres??""} ${t.apellidos??""} (c\xF3digo ${t.codigo}):`);if(!e||!e.trim())return;let s=confirm("\xBFOtorgar horas de la sesi\xF3n?");try{let l=await f(this.api.checkInFueraDeHora(this.sesionId(),{codigo:t.codigo,justificacion:e.trim(),otorgar_horas:s}));l&&y(l)?(await this.refreshAsistencias(!0),await this.loadParticipantes()):alert(l?.message||"No se pudo justificar la asistencia.")}catch(l){alert(l?.error?.message||"Error al justificar la asistencia.")}}async validarTodo(){try{let t=await f(this.api.validarAsistenciasSesion(this.sesionId(),{}));if(!t||!y(t)){alert(t?.message||"No se pudo validar.");return}await this.refreshAsistencias(!0),await this.loadParticipantes()}catch(t){alert(t?.error?.message||"Error al validar.")}}async refreshAsistencias(t=!1){try{let e=t?void 0:this.etag,s=await f(this.api.listarAsistenciasSesionPoll(this.sesionId(),e));if(s.ok&&s.notModified)return;if(s.ok&&s.data){this.asistencias.set(s.data),this.etag=s.etag;let l=s.lastModified?new Date(s.lastModified):new Date;this.lastSync.set(l)}}catch(e){this.error.set(e?.error?.message||"No se pudo actualizar asistencias.")}}async loadParticipantes(){try{let t=await f(this.api.listarParticipantesSesion(this.sesionId()));t&&y(t)?this.participantes.set(t.data??[]):this.participantes.set([])}catch(t){this.error.set(t?.error?.message||"No se pudo listar participantes.")}}minutosRestantes(){let t=this.ventana();if(!t?.expires_at)return null;let e=new Date(t.expires_at).getTime(),s=this.now().getTime(),l=Math.ceil((e-s)/6e4);return l>0?l:0}};E.\u0275fac=function(e){return new(e||E)},E.\u0275cmp=C({type:E,selectors:[["app-proyecto-assistance-page"]],decls:54,vars:13,consts:[["emptyAsistencias",""],["emptyParticipantes",""],["sinAsistencia",""],[1,"p-4","lg:p-6"],[1,"flex","items-center","gap-3","mb-5"],[1,"text-xl","font-semibold"],[1,"text-xs","text-slate-500","ml-auto"],[4,"ngIf"],[1,"grid","grid-cols-1","lg:grid-cols-2","gap-6"],[1,"rounded-xl","border","bg-white","shadow-sm","p-4"],[1,"flex","items-center","justify-between","mb-3"],[1,"text-sm","text-slate-700"],[1,"text-xs","text-slate-500"],[1,"space-y-3"],[1,"block","text-sm","text-slate-700"],["placeholder","Ej: 202012345",1,"w-full","border","rounded-lg","px-3","py-2",3,"keyup.enter","formControl"],[1,"flex","flex-wrap","gap-2"],[1,"px-3","py-1.5","rounded","border","border-indigo-300","bg-indigo-50","hover:bg-indigo-100",3,"click"],[1,"px-3","py-1.5","rounded","border",3,"click"],[1,"text-sm","font-semibold","text-slate-700"],[1,"flex","gap-2"],[1,"px-3","py-1.5","rounded","border","border-emerald-300","bg-emerald-50","hover:bg-emerald-100",3,"click"],[4,"ngIf","ngIfElse"],[1,"rounded-xl","border","bg-white","shadow-sm","p-4","mt-6"],[1,"text-xs","text-slate-400"],[1,"p-3","rounded","bg-rose-50","text-rose-700","border","border-rose-200","mb-4"],[1,"overflow-x-auto"],[1,"min-w-full","text-sm","table-fixed"],[1,"text-left","px-2","py-1","w-20"],[1,"text-left","px-2","py-1","w-28"],[1,"text-left","px-2","py-1"],[1,"text-left","px-2","py-1","w-24"],["class","border-t",4,"ngFor","ngForOf","ngForTrackBy"],[1,"border-t"],[1,"px-2","py-1","whitespace-nowrap"],[1,"text-left","px-2","py-1","w-40"],[1,"text-left","px-2","py-1","w-48"],[3,"ngSwitch"],["class","text-emerald-700 bg-emerald-50 border border-emerald-200 px-2 py-0.5 rounded text-xs",4,"ngSwitchCase"],["class","text-rose-700 bg-rose-50 border border-rose-200 px-2 py-0.5 rounded text-xs",4,"ngSwitchCase"],["class","text-slate-500 bg-slate-50 border border-slate-200 px-2 py-0.5 rounded text-xs",4,"ngSwitchDefault"],[1,"px-3","py-1.5","rounded","border","disabled:opacity-50",3,"click","disabled"],[1,"px-3","py-1.5","rounded","border","border-amber-300","bg-amber-50","hover:bg-amber-100","disabled:opacity-50",3,"click","disabled"],[1,"text-emerald-700","bg-emerald-50","border","border-emerald-200","px-2","py-0.5","rounded","text-xs"],[1,"text-rose-700","bg-rose-50","border","border-rose-200","px-2","py-0.5","rounded","text-xs"],[1,"text-slate-500","bg-slate-50","border","border-slate-200","px-2","py-0.5","rounded","text-xs"]],template:function(e,s){if(e&1){let l=T();n(0,"div",3)(1,"div",4)(2,"h1",5),a(3,"Llamado manual"),i(),n(4,"span",6),a(5),w(6,"date"),i(),_(7,W,4,4,"ng-container",7),i(),_(8,X,3,1,"ng-container",7),n(9,"div",8)(10,"section",9)(11,"div",10)(12,"div",11)(13,"b"),a(14),i()(),n(15,"div",12),_(16,Y,5,1,"ng-container",7),i()(),n(17,"div",13)(18,"label",14),a(19,"C\xF3digo del estudiante"),i(),n(20,"input",15),g("keyup.enter",function(){return p(l),u(s.doCheckIn())}),i(),n(21,"div",16)(22,"button",17),g("click",function(){return p(l),u(s.doCheckIn())}),a(23," Registrar "),i(),n(24,"button",18),g("click",function(){return p(l),u(s.activarManual())}),a(25," Renovar ventana (\xB11h por horario) "),i(),n(26,"button",18),g("click",function(){return p(l),u(s.refreshAsistencias(!0))}),a(27," Actualizar asistencias "),i(),n(28,"button",18),g("click",function(){return p(l),u(s.loadParticipantes())}),a(29," Actualizar participantes "),i()(),n(30,"p",12),a(31," Consejo: puedes usar un lector de c\xF3digos de barras o ingresar manualmente y presionar Enter. "),i()()(),n(32,"section",9)(33,"div",10)(34,"h2",19),a(35,"Registrados"),i(),n(36,"div",20)(37,"button",18),g("click",function(){return p(l),u(s.refreshAsistencias(!0))}),a(38," Actualizar "),i(),n(39,"button",21),g("click",function(){return p(l),u(s.validarTodo())}),a(40," Validar todos "),i()()(),_(41,ee,21,2,"div",22)(42,te,2,0,"ng-template",null,0,I),i()(),n(44,"section",23)(45,"div",10)(46,"h2",19),a(47,"Participantes (estado calculado)"),i(),n(48,"div",20)(49,"button",18),g("click",function(){return p(l),u(s.loadParticipantes())}),a(50," Actualizar "),i()()(),_(51,le,21,2,"div",22)(52,ce,2,0,"ng-template",null,1,I),i()()}if(e&2){let l,d=A(43),U=A(53);o(5),S(" Ahora: ",P(6,10,s.now(),"shortTime")," "),o(2),c("ngIf",s.lastSync()),o(),c("ngIf",s.error()),o(6),S("Sesi\xF3n #",s.sesionId()),o(2),c("ngIf",(l=s.ventana())==null?null:l.expires_at),o(4),c("formControl",s.codigo),o(21),c("ngIf",s.asistencias().length)("ngIfElse",d),o(10),c("ngIf",s.participantes().length)("ngIfElse",U)}},dependencies:[j,D,V,F,R,M,L,q,$,z,G,J,B],encapsulation:2,changeDetection:0});var Q=E;export{Q as ProyectoAssistancePage};
